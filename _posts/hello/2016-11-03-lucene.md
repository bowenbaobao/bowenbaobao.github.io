---
layout: post
title: lucene 笔记
permalink: /:categories/lucene_url/
date: 2016-11-01 09:30:15 +0800
category: Java Search
tags: [lucene]
---



### Lucene 4.10.4

####  POM配置
```
<!-- org.apache.lucene 4.10.4 -->
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-core</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-analyzers-common</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-queryparser</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-highlighter</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-sandbox</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-queries</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-memory</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-codecs</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-analyzers-icu</artifactId>
			<version>4.10.4</version>
		</dependency>
```

####  IK配置

##### IK包

```
		<dependency>
			<groupId>org.wltea</groupId>
			<artifactId>IKAnalyzer</artifactId>
			<version>IKAnalyzer2012FF_u1</version>
		</dependency>
```
IK包名:IKAnalyzer-IKAnalyzer2012FF_u1.jar


#####   行业词


IKAnalyzer.cfg.xml

```

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">  
<properties>  
	<comment>IK Analyzer 扩展配置</comment>
	
	<!--用户可以在这里配置自己的扩展字典--> 
	<entry key="ext_dict">industry_dict.dic;</entry> 
	
	<!--用户可以在这里配置自己的扩展停止词字典-->
	<entry key="ext_stopwords">stopword.dic;</entry> 
	
</properties>

```


industry_dict.dic
stopword.dic


##### 动态添加词库

IK 动态添加词库，不需重启Web服务器

```

package com.sekorm.searchengine.controller;

import java.io.IOException;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.lucene.analysis.Analyzer;
import org.apache.lucene.analysis.TokenStream;
import org.apache.lucene.analysis.tokenattributes.CharTermAttribute;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.wltea.analyzer.cfg.Configuration;
import org.wltea.analyzer.dic.Dictionary;
import org.wltea.analyzer.lucene.IKAnalyzer;

import com.sekorm.searchengine.common.MainController;

/**
 * 
 * @describe 做敏感词专用
 *
 * @author bowen_bao
 * @date 2015年9月8日
 */
@Controller
@RequestMapping(value = "/testik", produces = "application/json;;charset=UTF-8")
public class TestIkAnalyzerController extends MainController {

    private static Logger logger = LoggerFactory.getLogger(TestIkAnalyzerController.class);
    
    
    
    @RequestMapping(value = "/query")
    @ResponseBody
    public List<String> getAnalyzer(String q,HttpServletRequest request, HttpServletResponse response) {
    	
    	List<String> list=new ArrayList<String>();
    	String text=q;
		Analyzer anal=new IKAnalyzer();
		
		Configuration cfg=org.wltea.analyzer.cfg.DefaultConfig.getInstance();
		List<String> listdic=cfg.getExtDictionarys();
		for(String s:listdic){
			System.out.println(s);
		}
		
		cfg.setUseSmart(true);
		Dictionary.initial(cfg);
		Dictionary dictionary = Dictionary.getSingleton();
		List<String> mywords=new ArrayList<String>();
		mywords.add("张伟");
		mywords.add("深圳罗");
		dictionary.addWords(mywords);
		List<String> mydisablewords=new ArrayList<String>();
		mydisablewords.add("包围");
		mydisablewords.add("为什么");
		mydisablewords.add("深圳");
		dictionary.disableWords(mydisablewords);
		
		
		StringReader reader=new StringReader(text);
		try {
			if(text.length()>1){
				TokenStream ts=anal.tokenStream("", reader);
				CharTermAttribute term=ts.getAttribute(CharTermAttribute.class);
				ts.reset();
				while(ts.incrementToken()){
					list.add(term.toString());
				}
			}else{
				list.add(text);
			}
			anal.close();
			reader.close();
		} catch (IOException e) {
			logger.error("TestIkAnalyzerController getAnalyzer error:",e);
		}
    	return list;
    }
    
}



```


#### java 代码块

#####  SearchConstant 

全局配置类

```
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Properties;
import org.apache.lucene.document.DoubleField;
import org.apache.lucene.document.FieldType;
import org.apache.lucene.document.FloatField;
import org.apache.lucene.document.IntField;
import org.apache.lucene.document.LongField;
import org.apache.lucene.index.FieldInfo.IndexOptions;
import org.apache.lucene.util.Version;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * @describe 系统常量类
 * @author bowen_bao
 * @date 2015年9月8日
 */
public class SearchConstant {
	
	 private static Logger logger = LoggerFactory.getLogger(SearchConstant.class);
		  
	 //搜索index path
	 public final static String ECNEW_INDEX_PATH="/opt/searchIndex/ecnew";        //服务器搜索索引库地址
	 
	 //搜索lucene版本
	 public final static Version SYS_LUCENE_VERSION=Version.LUCENE_4_10_4;
	 
	 //搜索高亮标签
	 public final static String HIGHLIGHT_BEGIN="<font color='#ec6a00'>"; 
	 public final static String HIGHLIGHT_END="</font>";
	
	 //定义索引的数据格式
	public static final FieldType STORE_YES_ANALYZED=new FieldType();//存储、分词
	public static final FieldType STORE_YES_ANALYZED_NO=new FieldType();//存储，不分词
	public static final FieldType STORE_YES_INDEX_NO=new FieldType();//存储，不索引
	public static final FieldType STORE_NO_ANALYZED=new FieldType();//不存储，分词
	public static final FieldType STORE_NO_ANALYZED_NO=new FieldType();//不存储，不分词
	
	public static final FieldType STORE_YES_INT=IntField.TYPE_STORED;//Int 存储
	public static final FieldType STORE_YES_LONG=LongField.TYPE_STORED;//Long 存储
	public static final FieldType STORE_YES_FLOAT=FloatField.TYPE_STORED;//Float 存储
	public static final FieldType STORE_YES_DOUBLE=DoubleField.TYPE_STORED;//Double存储
		
		
		static{
			STORE_YES_ANALYZED.setStored(true);
			STORE_YES_ANALYZED.setIndexed(true);
			STORE_YES_ANALYZED.setTokenized(true);//分词
			STORE_YES_ANALYZED.setOmitNorms(false);//是否忽略加权基准值     true:忽略    false:不忽略      加权基准值:长度标准化因子、字段权重
			/**
			    IndexOptions  修改倒排索引属性
				IndexOptions.DOCS_ONLY  documemts被索引，词频和位置被忽略
				IndexOptions.DOCS_AND_FREQS   documents、词频被索引，term位置被忽略    对field短语或有关位置的查询会抛异常
				IndexOptions.DOCS_AND_FREQS_AND_POSITIONS  全文索引的默认设置：打分、位置检索都支持
				IndexOptions.DOCS_AND_FREQS_AND_POSITIONS_AND_OFFSETS  索引字符相对位置的偏移量
			 */
			STORE_YES_ANALYZED.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);
			STORE_YES_ANALYZED.freeze(); //阻止field属性未来可能的变更
			
			
			STORE_YES_ANALYZED_NO.setStored(true);
			STORE_YES_ANALYZED_NO.setIndexed(true);
			STORE_YES_ANALYZED_NO.setTokenized(false);
			STORE_YES_ANALYZED_NO.setOmitNorms(false);
			STORE_YES_ANALYZED_NO.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);
			STORE_YES_ANALYZED_NO.freeze();
			
			
			STORE_YES_INDEX_NO.setStored(true);
			STORE_YES_INDEX_NO.setIndexed(false);
			STORE_YES_INDEX_NO.setTokenized(false);
			STORE_YES_INDEX_NO.setOmitNorms(true);
			STORE_YES_INDEX_NO.setIndexOptions(null);//只存储，不索引，无倒排索引属性
			STORE_YES_INDEX_NO.freeze();
			
			
			STORE_NO_ANALYZED.setStored(false);
			STORE_NO_ANALYZED.setIndexed(true);
			STORE_NO_ANALYZED.setTokenized(true);
			STORE_NO_ANALYZED.setOmitNorms(false);
			STORE_NO_ANALYZED.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);
			STORE_NO_ANALYZED.freeze();
			
			STORE_NO_ANALYZED_NO.setStored(false);
			STORE_NO_ANALYZED_NO.setIndexed(true);
			STORE_NO_ANALYZED_NO.setTokenized(false);
			STORE_NO_ANALYZED_NO.setOmitNorms(false);
			STORE_NO_ANALYZED_NO.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);
			STORE_NO_ANALYZED_NO.freeze();
			
		}
		
		
		//indexReader刷新器时间
		public static final long INDEXREADER_SLEEP_TIME=1*1000L;
			    
		 
		
}

```


#####   SearchUtil

核心类：  Analyzer 、 IndexWriter 、 IndexSearch 、 Similarity 的定义

```

import java.io.File;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import org.apache.lucene.analysis.Analyzer;
import org.apache.lucene.analysis.miscellaneous.PerFieldAnalyzerWrapper;
import org.apache.lucene.index.DirectoryReader;
import org.apache.lucene.index.IndexReader;
import org.apache.lucene.index.IndexWriter;
import org.apache.lucene.index.IndexWriterConfig;
import org.apache.lucene.index.IndexWriterConfig.OpenMode;
import org.apache.lucene.search.IndexSearcher;
import org.apache.lucene.search.similarities.Similarity;
import org.apache.lucene.store.Directory;
import org.apache.lucene.store.FSDirectory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;
import org.wltea.analyzer.lucene.IKAnalyzer;
import com.sekorm.searchengine.common.constant.SearchConstant;

@Component("searchUtil")
public class SearchUtil {
	
	private final Logger log = LoggerFactory.getLogger(this.getClass());
	
	private  IndexWriter indexWriter=null;
	private  IndexSearcher  indexSearcher=null;
	private  Analyzer analyzer=null;               //默认分词器
	private  Analyzer commaAnalyzer=null;          //自定义分词器
	private  String indexPath=SearchConstant.ECNEW_INDEX_PATH;  //索引path
	private  Similarity ecnewSimilarity=null;     //自定义相似器
	
	
	SearchUtil(){
		init();
	}
	
	/**
	 * 
	 * @describe 初始化相关数据
	 *
	 * @author bowen_bao
	 * @date 2015年7月20日
	 * @param
	 * @return
	 */
	public void init(){
		new Thread(){
			public void run(){
				initData();
			}
		}.start();
	}
	
	public synchronized void initData(){
		try {
			log.info("===SearchUtil initDate start===");
			
			//索引目录
			Directory indexDir=FSDirectory.open(new File(indexPath));
			
			Analyzer  defaultAnalyzer=new IKAnalyzer();
			Analyzer  patternAnalyzer=new PatternAnalyzer(",");
			Map<String,Analyzer> fieldAnalyzers=new HashMap<String,Analyzer>();
			//需要逗号分词的
			fieldAnalyzers.put("keyword", patternAnalyzer);
			fieldAnalyzers.put("searchKeyword", patternAnalyzer);
			fieldAnalyzers.put("brandName", patternAnalyzer);
			fieldAnalyzers.put("brandKeyword", patternAnalyzer);
			fieldAnalyzers.put("goodsName", patternAnalyzer);
			fieldAnalyzers.put("elecName", patternAnalyzer);
			fieldAnalyzers.put("sname",patternAnalyzer);
			fieldAnalyzers.put("skeyword", patternAnalyzer);
			fieldAnalyzers.put("plName",patternAnalyzer);
			fieldAnalyzers.put("plKeyword", patternAnalyzer);
			fieldAnalyzers.put("pnName",patternAnalyzer);
			fieldAnalyzers.put("pnKeyword", patternAnalyzer);
			fieldAnalyzers.put("pnResemblecode",patternAnalyzer);
			fieldAnalyzers.put("pnPackages",patternAnalyzer);
			fieldAnalyzers.put("pnPacking",patternAnalyzer);
			fieldAnalyzers.put("searchKeywordindex",patternAnalyzer);
			
			
			//PerFieldAnalyzerWrapper 可以使得不同的field使用不同的analyzer进行搜索,相当于Analyzer的组
			PerFieldAnalyzerWrapper ecanalyzer=new PerFieldAnalyzerWrapper(defaultAnalyzer,fieldAnalyzers);
			
			//创建indexWriter  索引写者
			IndexWriterConfig iwc=new IndexWriterConfig(SearchConstant.SYS_LUCENE_VERSION,ecanalyzer);
			iwc.setOpenMode(OpenMode.CREATE_OR_APPEND);
			//设置自己的相似器
			iwc.setSimilarity(getEcnewSimilarity());			
			indexWriter=new IndexWriter(indexDir, iwc);
			
			//创建indexSearcher  索引读者
			IndexReader indexReader=DirectoryReader.open(indexWriter,true);			
			indexSearcher=new IndexSearcher(indexReader);

			//设置自己的相似器
			indexSearcher.setSimilarity(getEcnewSimilarity());
			
			analyzer=new IKAnalyzer();
			
			log.info("===SearchUtil initDate end===");
			
		} catch (Exception e) {
			log.info("===SearchUtil initDate error===",e);
		}
	}
	
	public IndexWriter getIndexWriter(){
		if(indexWriter!=null){
			return indexWriter;
		}else{
			initData();
			return indexWriter;
		}
	}
	
	
	public IndexSearcher getIndexSearcher(){
		if(indexSearcher!=null){
			return indexSearcher;
		}else{
			initData();
			return indexSearcher;
		}
	}
	
	public Analyzer getAnalyzer(){
		if(analyzer!=null){
			return analyzer;
		}else{
			return new IKAnalyzer();
		}
	}
	
	/**
	 * 自定义{ 英文,}分词器
	 * @return   Analyzer
	 */
	public Analyzer getcommaAnalyzer(){
		if(commaAnalyzer!=null){
			return commaAnalyzer;
		}else{
			return new PatternAnalyzer(",");
		}
	} 
	
	/**
	 * Lucene 对时间段的查询比较弱，把时间转成long ,对long 进行范围search
	 * @describe  时间  ：  String yyyy-MM-dd hh:mm:ss 转Long	
	 * @author bowen_bao
	 * @date 2015年7月20日
	 * @param
	 * @return
	 */
	public Long DateStringToLong(String date){
		try {
			Date d=new SimpleDateFormat("yyyy-MM-dd hh:mm:ss").parse(date);
			return d.getTime();
		} catch (ParseException e) {
			log.error("SearchUtil  DateStringToLong error" + e.getMessage());
			e.printStackTrace();
		}
		return 0l;
	}
	
	
	//在indexWriter 更新索引后，索引commit，更新indexSearch
	public synchronized  void refreshSearch(){
		try {
			IndexReader oldReader=indexSearcher.getIndexReader();
			indexWriter.commit();
			IndexReader newReader=DirectoryReader.openIfChanged((DirectoryReader) oldReader,indexWriter,true);
			if(null!=newReader && newReader!=oldReader){
				indexSearcher=new IndexSearcher(newReader);
				indexSearcher.setSimilarity(getEcnewSimilarity());//更新indexSearch时，需要设置相似器
				Thread.sleep(SearchConstant.INDEXREADER_SLEEP_TIME);
				oldReader.close();
			}
		} catch (Exception e) {
			log.error("SearchUtil refreshSearch error ",e);
		}
	}
	
	public Similarity   getEcnewSimilarity(){
		if(ecnewSimilarity==null){
			ecnewSimilarity=new EcNewSimilarity();
			return ecnewSimilarity;
		}else{
			return ecnewSimilarity;
		}
	}
	
	
	//***************************************************非搜索Util
	
	/**
	 * list 集合转String  ,以 逗号连接
	 */
	public String  ListToString(List<String> list){
		String str="";
		for(String s:list){
			str+=s+",";
		}
		if(!"".equals(str)  &&  str.length()>0){
			str=str.substring(0, str.length()-1);
		}
		return str;
	}
	
	/**
	 * String  ,以 逗号连接 转 list 集合
	 */
	public List<String>  StringToList(String keyword){
		List<String> list=new ArrayList<String>();
		String[] str=keyword.split(",");
		for(int i=0;i<str.length;i++){
			list.add(str[i]);
		}
		return list;
	}
	
}

```

#####  EcNewSimilarity  

自定义相似器 ,修改打分公式,直接影响搜索排名

```
import org.apache.lucene.index.FieldInvertState;
import org.apache.lucene.search.similarities.DefaultSimilarity;

/**
 * 扩展相似器   扩展自己的打分机制
 * @author bowen_bao
 *
 */
public class EcNewSimilarity extends DefaultSimilarity{	
	
	//词频
	@Override
	public float tf(float freq){//tf 开根号
		return 1.0f;
//		return freq;
	}
	
	//逆向文档频率：所有文档中出现的频率
	@Override
	public float idf(long docFreq,long numDocs){
		return 1.0f;
	}
	
	//长度因子  关键字占某文档包含所有词项的频率
	@Override
	public float lengthNorm(FieldInvertState state){
		return 1.0f;
	}
	
	
	//term 与   term 之间的距离因素
	@Override
	public float sloppyFreq(int distance){
		return 1.0f;
	}
	
	
	//每一个Document 中所有匹配的关键字与当前关键字的匹配比例因素影响
	//这个分值衡量了文档中含有多少term，文档中出现的越多，越全，将获得越高的分值。
	//demo:  查询lucene  和   apache  , 同时出现两个term 的肯定比只出现一个lucene 或者 apache 的分值高
	@Override
	public float coord(int overlap,int maxOverlap){
		return 1.0f;
	}
	
	
 
	/**
	 * 搜索权重因子  
	 * 这个标准化因子用于多个查询器中进行比较，它不影响文档的排名，它的主要作用在于多个查询器返回的结果进行比较，甚至是结果来自
	 * 多个索引时。这是搜索时的权重因子，当给查询器设置权重时就是通过这个因子进行影响的.
	 */
	 public float queryNorm(float sumOfSquaredWeights)//queryNorm 可以不用管，不影响排序结果
	    {
		 return 1.0f;
	    }	
	
}
```


##### PatternAnalyzer 

自定义分词器

```
import java.io.Reader;
import java.util.regex.Pattern;
import org.apache.lucene.analysis.Analyzer;
import org.apache.lucene.analysis.TokenStream;
import org.apache.lucene.analysis.core.LowerCaseFilter;
import org.apache.lucene.analysis.pattern.PatternTokenizer;

/**
 * 自定义分词器
 * @author bowen_bao
 *
 */
public class PatternAnalyzer extends  Analyzer{
	
	
	private Pattern pattern;
	private boolean toLowerCase;
	
	public PatternAnalyzer(String regex){
		this(regex,true);    //全部转小写
//		this(regex,false);   //不处理
	}
	public PatternAnalyzer(String regex,boolean toLowerCase){
		this.pattern=Pattern.compile(regex);
		this.toLowerCase=toLowerCase;
	}
	
	public PatternAnalyzer(Pattern pattern,boolean toLowerCase){
		this.pattern=pattern;
		this.toLowerCase=toLowerCase;
	}
	
	@SuppressWarnings("resource")
	@Override
	protected TokenStreamComponents createComponents(String arg0, Reader arg1) {
		PatternTokenizer tokenizer=new PatternTokenizer(arg1,pattern,-1);
		TokenStream result =toLowerCase?new LowerCaseFilter(tokenizer):tokenizer;
		return new TokenStreamComponents(tokenizer,result);
	}
	
}

```

#####  SortUtil


自定义排序规则

```
import org.apache.lucene.search.SortField;
import org.springframework.stereotype.Component;

/**
 * 根据业务或其排序规则
 * 
 * @author bowen_bao
 * 
 */
@Component("sortUtil")
public class SortUtil {


	/**
	 * @description 资讯的业务排序规则
	 */
	public SortField[] getEcnewSort() {

		// 资讯资料综合排序 sort
		SortField ecSort = new SortField("sortEc", SortField.Type.INT, true);

		// updatetime sort
		SortField publishtimeSort = new SortField("longpublishTime",
				SortField.Type.LONG, true);

		// SortField.FIELD_SCORE 文档得分
		SortField[] ecnewSort = new SortField[] { 
				SortField.FIELD_SCORE, ecSort,publishtimeSort };

		return ecnewSort;

	}

	public SortField[] getPnSort() {

		// 资讯资料综合排序 sort
		SortField pnSort = new SortField("sortPn", SortField.Type.INT, true);

		// updatetime sort
		SortField publishtimeSort = new SortField("longpublishTime",
				SortField.Type.LONG, true);

		// SortField.FIELD_SCORE 文档得分
		SortField[] sort = new SortField[] { SortField.FIELD_SCORE, pnSort,
				publishtimeSort };
		return sort;

	}

}

```

#####  QueryUtil 


自定义各类lucene Query  [这个类比较杂，无参考价值]

```
import java.io.IOException;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import org.apache.lucene.analysis.Analyzer;
import org.apache.lucene.analysis.TokenStream;
import org.apache.lucene.analysis.tokenattributes.CharTermAttribute;
import org.apache.lucene.index.Term;
import org.apache.lucene.queryparser.classic.ParseException;
import org.apache.lucene.queryparser.classic.QueryParser;
import org.apache.lucene.search.BooleanClause;
import org.apache.lucene.search.BooleanClause.Occur;
import org.apache.lucene.search.BooleanQuery;
import org.apache.lucene.search.DisjunctionMaxQuery;
import org.apache.lucene.search.NumericRangeQuery;
import org.apache.lucene.search.PhraseQuery;
import org.apache.lucene.search.Query;
import org.apache.lucene.search.TermQuery;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

@Component("queryUtil")
public class QueryUtil {
	
	private final Logger log = LoggerFactory.getLogger(this.getClass());
	
	@Autowired
	private SearchUtil searchUtil;
	
	//*****************************************************************业务Query
	
	/**
	 * 	单一词完全匹配，无需分词
	 * @param field   
	 * @param keyword
	 * @return
	 */
	public 	Query  getTermQuery(String field,String keyword){
		return	 new TermQuery(new Term(field,keyword.toLowerCase()));
	}	

	
	/**
	 * @describe 全命中匹配（无序）
	 * @param field
	 * @param keyword
	 * @param analyzer
	 * @return
	 */
	public  Query getFullHitQuery(String field,String keyword,Analyzer analyzer){
		try {
			List<String> wordList=getTokenList(keyword, analyzer);
			if(wordList.size()==0){
				return null;
			}
			BooleanQuery fullHitBQ=new BooleanQuery(true);//全部命中查询
			for(String word:wordList){
				fullHitBQ.add(new TermQuery(new Term(field,word)),BooleanClause.Occur.MUST);
			}
			return fullHitBQ;
		} catch (Exception e) {
			log.error("QueryUtil  getFullHitQuery error:",e);
		}
		return null;
	} 
	
	/**
	 * 部分命中匹配（无序）
	 */
	public  Query getPartHitQuery(String field,String keyword,Analyzer analyzer){
		try {
			List<String> wordList=getTokenList(keyword, analyzer);
			if(wordList.size()==0){
				return null;
			}
			
			wordList=singleFilter(wordList);
			if(wordList==null  ||  wordList.size()==0){
				return null;
			}
			
			BooleanQuery fullHitBQ=new BooleanQuery(true);
			for(String word:wordList){
				fullHitBQ.add(new TermQuery(new Term(field,word)),BooleanClause.Occur.SHOULD);
			}
			
			return fullHitBQ;
		} catch (Exception e) {
			log.error("QueryUtil  getPartHitQuery error:",e);
		}
		return null;
	} 
	
	
	
	/**
	 * 范围搜索
	 * @param field
	 * @param id
	 * @return
	 */

	public Query getNumericRangeQuery(String field,Integer id){
		Query queryid=NumericRangeQuery.newIntRange(field, id, id, true, true);
		return queryid;
	}
	
	/**
	 * 获取分词之后的数组
	 * @param text
	 * @param analyzer
	 * @return
	 */
	public List<String> getTokenList(String text ,Analyzer analyzer){
		if(null== text || text.trim().isEmpty()  || null==analyzer ){
			return new ArrayList<String>();
		}
		List<String> list=new ArrayList<String>();
		TokenStream ts=null;
		try {
			ts=analyzer.tokenStream(null, new StringReader(text));
			CharTermAttribute term=ts.addAttribute(CharTermAttribute.class);
			ts.reset();
			while(ts.incrementToken()){
				list.add(term.toString());
			}
			ts.end();
		} catch (Exception e) {
			log.error("EcNewIndexService  getTokenList error:",e);
		}finally{
			if(ts!=null){
				try {
					ts.close();
				} catch (IOException e) {
					log.error("EcNewIndexService  getTokenList error:",e);
				}
			}
		}
//		if(!list.contains(text)){
//			list.add(text);
//		}
		return list;
	}
	
	/**
	 * 判断是否是汉字
	 * @param c
	 * @return
	 */
	public boolean isChineseChar(char c){
		return c>=19968  &&  c<=40869;
	}
	
	/**
	 * 判断是否为中文词元
	 * @param keyword
	 * @param analyzer
	 * @return
	 */
	public boolean isSigleChinese(String keyword,Analyzer analyzer){
		List<String> wordList=getTokenList(keyword, analyzer);
		if(wordList==null || wordList.size()==0){
			return false;
		}
		if(wordList.size()==1){
			return true;
		}else{
			return false;
		}
		
	}
	
	
	
	
	
	//*********************************************************************非业务Query
	

	/**
	 * @describe  短语查询(全匹配)   待测试
	 * @author bowen_bao
	 * @date 2015年7月24日
	 * @param offset 默认为0
	 * @return
	 */
	public PhraseQuery getPhraseQuery(String field,String keyword,Analyzer analyzer,int offset){
		if(keyword==null || "".equals(keyword)){
			return null;
		}
		try {
			List<String> wordList=getTokenList(keyword, analyzer);
			if(wordList.size()==0){
				return null;
			}
			
			wordList=singleFilter(wordList);
			
			if(wordList==null  ||  wordList.size()==0){
				return null;
			}
			
			PhraseQuery phraseQuery=new PhraseQuery();
			phraseQuery.setSlop(offset);
			for(String word:wordList){
				phraseQuery.add(new Term(field,word));
			}
			return phraseQuery;
		} catch (Exception e) {
			log.error(e.getMessage());
		}
		return null;
	}
	
	
	
	public DisjunctionMaxQuery getPhraseQuerytest(String field,String keyword,Analyzer analyzer,int offset){
		if(keyword==null || "".equals(keyword)){
			return null;
		}
		try {
			List<String> wordList=getTokenList(keyword, analyzer);
			if(wordList.size()==0){
				return null;
			}
			DisjunctionMaxQuery maxQ=new DisjunctionMaxQuery(0.0f);
			BooleanQuery blQ=new BooleanQuery(true); 
			for(String word:wordList){
				PhraseQuery phraseQuery=new PhraseQuery();
				phraseQuery.setSlop(offset);
				phraseQuery.add(new Term(field,word));
				blQ.add(phraseQuery,Occur.MUST);
			}
			maxQ.add(blQ);
			return maxQ;
		} catch (Exception e) {
			log.error(e.getMessage());
		}
		return null;
	}

	
	
	
	
	
	
	
	/**
	 * 是否存在查询              存在- 加权值    
	 * @param field
	 * @param keyword
	 * @param analyzer
	 * @param allWeight
	 * @param partWeight
	 * @return
	 */
	public Query isExistQuery(String field,String keyword,Analyzer analyzer,float weight){
		BooleanQuery blQ=new BooleanQuery(true);
		boolean isSigleChinese=isSigleChinese(keyword, analyzer);
		if(isSigleChinese){
			//全匹配Query
			Query allQ=getTermQuery(field,keyword);
			allQ.setBoost(weight);
			blQ.add(allQ,Occur.SHOULD);
		}else{
			List<String> wordList=getTokenList(keyword, analyzer);
			if(wordList==null  ||  wordList.size()==0){
				return null;
			}
			//分词部分匹配Query
			Query partQ=getPartHitQuery(field,keyword,analyzer);
			partQ.setBoost(weight);
			blQ.add(partQ,Occur.SHOULD);
		}
		
		return blQ;
	}
	
	
	
	
	/**
	 * 	单一词完全匹配，无需分词
	 * @param field   
	 * @param keyword
	 * @return
	 */
	public 	Query  getSingleQuerybak(String field,String keyword,Analyzer analyzer){
		try {
			List<String> wordList=getTokenList(keyword, analyzer);
			if(wordList.size()==0){
				return null;
			}else if(wordList.size()==1){
				BooleanQuery fullHitBQ=new BooleanQuery(true);
				for(String word:wordList){
					fullHitBQ.add(new TermQuery(new Term(field,word)),Occur.MUST);
				}
				return fullHitBQ;
			}else{
				return null;
			}
		} catch (Exception e) {
			log.error("QueryUtil  getPartHitQuery error:",e);
		}
		return null;
	}
	
	
	public List<String> singleFilter(List<String> wordList){
		if(wordList==null || wordList.size()==0){
			return null;
		}
		if(wordList.size()>1){
			List<String> list=new ArrayList<String>();
			
			if(wordList.size()==2){
				if(wordList.get(0).toLowerCase().endsWith(wordList.get(1).toLowerCase())){
					list.add(wordList.get(0));
					return list;
				}
			}
			
			for(String s:wordList){
				 Pattern intP =Pattern.compile("[0-9]");
				 Pattern strP =Pattern.compile("[a-zA-Z]");
				 if(!intP.matcher(s).matches()&& !strP.matcher(s).matches()){
						String regEx="[\\u4e00-\\u9fa5]";
						Pattern p=Pattern.compile(regEx);
						Matcher m=p.matcher(s);
						int nCount=0;
						while(m.find()){
							 for(int i=0;i<=m.groupCount();i++){
								 nCount++;
							 }
						}
						if(nCount!=1){
							list.add(s);
						}
				 } 
			}
			return list;
		}
		
		return wordList;
	}
	
	
	//===============================================v2 新增
	public Query fieldListKeywordTermQuery(String field,String keyword,Analyzer analyzer){
			BooleanQuery blQ=new BooleanQuery(true);
			List<String> wordList=getTokenList(keyword, analyzer);
			if(wordList==null  ||  wordList.size()==0){
				return null;
			}
			for(String k:wordList){
				Query q=getTermQuery(field, k);
				blQ.add(q,Occur.SHOULD);
			}
		return blQ;
	}
	
	
	public Query getKeywordPharseQuery(String field,String keyword,Analyzer analyzer,int offset)throws ParseException {
		QueryParser parser=new QueryParser(field, analyzer);
		Query q= parser.createPhraseQuery(field, keyword, offset);
		return q;
	}
	
	public Query getKeywordHalfMatchQuery(String field,String keyword,Analyzer analyzer,boolean isHalf)throws ParseException {
		if(keyword==null || "".equals(keyword)){
			return null;
		}
		try {
			BooleanQuery blQ=new BooleanQuery(true);
			List<String> wordList=getTokenList(keyword, analyzer);
			wordList=singleFilter(wordList);
			if(wordList.size()==0){
				return null;
			}
			for(String word:wordList){
				if(isHalf){
					if(word.length()*2>=keyword.length()){
						Query q=getTermQuery(field, word);
						blQ.add(q, Occur.SHOULD);
					}
				}else{
					if(word.length()*2<keyword.length()){
						Query q=getTermQuery(field, word);
						blQ.add(q, Occur.SHOULD);
					}
				}
			}
			return blQ;
		} catch (Exception e) {
			log.error(e.getMessage());
		}
		return null; 
	}
	
	//只能做坡度为0的短语查询
	public Query getQuestionTitleQuery1(String field,String keyword,Analyzer analyzer)throws ParseException {
		QueryParser parser=new QueryParser(field, analyzer);
		Query q= parser.createPhraseQuery(field, keyword);
		return q;
	}
	
	public Query getQuestionTitleQuery(String field,String keyword,Analyzer analyzer)throws ParseException {
		QueryParser parser=new QueryParser(field, analyzer);
		Query q= parser.parse(keyword);
		return q;
	}
	
	
	
}

```


#####  IkHightLight 

高亮处理

```
import java.io.IOException;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.List;
import org.apache.lucene.analysis.Analyzer;
import org.apache.lucene.analysis.TokenStream;
import org.apache.lucene.analysis.tokenattributes.CharTermAttribute;
import org.apache.lucene.index.Term;
import org.apache.lucene.search.BooleanClause;
import org.apache.lucene.search.BooleanQuery;
import org.apache.lucene.search.PhraseQuery;
import org.apache.lucene.search.Query;
import org.apache.lucene.search.highlight.Highlighter;
import org.apache.lucene.search.highlight.NullFragmenter;
import org.apache.lucene.search.highlight.QueryScorer;
import org.apache.lucene.search.highlight.SimpleHTMLFormatter;
import org.springframework.stereotype.Component;
import org.wltea.analyzer.lucene.IKAnalyzer;
import com.sekorm.searchengine.common.constant.SearchConstant;
import com.sekorm.searchengine.searchutil.PatternAnalyzer;
import com.sekorm.searchengine.vo.SearchEcObjVO;


@Component("ikHightLight")
public class IkHightLight {
	// 搜索高亮标签
	public static final String HIGHLIGHT_BEGIN =   SearchConstant.HIGHLIGHT_BEGIN; // 高亮开始标记符    
	public static final String HIGHLIGHT_END = SearchConstant.HIGHLIGHT_END; // 高亮结束标记符

	public static void main(String[] args) {
//		String title = "PCap01AX";
//		String keyword = "PCap01A";
//
//		// ik分词，分出来标红
//		IKAnalyzer ikAnalyzer = new IKAnalyzer();
//		List<String> ikTokenList = getTokenList(keyword, ikAnalyzer);
//		System.out.println("keyword=" + keyword);
//		System.out.println("===ik分词===");
//		for (String token : ikTokenList) {
//			System.out.println(token);
//		}
//
//		// 构造高亮查询
//		BooleanQuery highLightQuery = new BooleanQuery();
//		PatternAnalyzer patternAnalyzer = new PatternAnalyzer(""); // 单字符分词
//		for (String token : ikTokenList) {
//			Query phraseQuery = getPhraseQuery("title", token, patternAnalyzer);
//			highLightQuery.add(phraseQuery, BooleanClause.Occur.SHOULD);
//		}
//
//		// 高亮标题
//		String highLightTitle = highLight(title, highLightQuery,
//				patternAnalyzer);
//		System.out.println("title=" + title);
//		System.out.println("highLightTitle=" + highLightTitle);
		
//		List<SearchEcObjVO> list=new ArrayList<SearchEcObjVO>();
//		SearchEcObjVO vo=new SearchEcObjVO();
//		 vo.setTitle("PCap01AX"); list.add(vo);
//		 sekormhigh(list,"PCap01");
//		 
//		 for(SearchEcObjVO v:list){
//			 System.out.println(v.getTitle());
//		 }
	}
	
	
	public   void sekormhigh(List<SearchEcObjVO> list,String keyword){

		// ik分词，分出来标红
		IKAnalyzer ikAnalyzer = new IKAnalyzer();
		List<String> ikTokenList = getTokenList(keyword, ikAnalyzer);
		for (String token : ikTokenList) {
			System.out.println(token);
		}

		// 构造高亮查询
		BooleanQuery highLightQuery = new BooleanQuery();
		PatternAnalyzer patternAnalyzer = new PatternAnalyzer(""); // 单字符分词
		for (String token : ikTokenList) {
			Query phraseQuery = getPhraseQuery("title", token, patternAnalyzer);
			highLightQuery.add(phraseQuery, BooleanClause.Occur.SHOULD);
		}

		// 高亮标题
		for(SearchEcObjVO ecnew:list){//只高亮title  summery
			ecnew.setTitle(highLight(ecnew.getTitle(),highLightQuery,patternAnalyzer));
			ecnew.setSummary(highLight(ecnew.getSummary(),highLightQuery,patternAnalyzer));
		}
		 
	}

	public static String highLight(String title, Query query, Analyzer analyzer) {
		// 高亮器
		SimpleHTMLFormatter simpleHTMLFormatter = new SimpleHTMLFormatter(
				HIGHLIGHT_BEGIN, HIGHLIGHT_END);
		Highlighter highlighter = new Highlighter(simpleHTMLFormatter,
				new QueryScorer(query));
		highlighter.setTextFragmenter(new NullFragmenter());

		// 高亮标题
		String hTitle = highLight(title, highlighter, analyzer);
		return hTitle;
	}

	/**
	 * 高亮文本
	 * 
	 * @param text
	 * @param highlighter
	 * @param analyzer
	 * @return 失败：null
	 */
	public static String highLight(String text, Highlighter highlighter,
			Analyzer analyzer) {
		if (text == null || text.length() == 0) {
			return text;
		}

		try {
			String hlText = highlighter.getBestFragment(analyzer, null, text);
			if (hlText != null) {
				// 合并连续命中区域
				hlText = hlText.replace(HIGHLIGHT_END + HIGHLIGHT_BEGIN, ""); // 中文文本存在此情况
				hlText = hlText.replace(HIGHLIGHT_END + " " + HIGHLIGHT_BEGIN,
						" "); // 英文文本存在此情况
				return hlText;
			} else {
				return text;
			}
		} catch (Exception e) {
			e.printStackTrace();
		}

		return null;
	}

	/**
	 * 返回分词后的词列表
	 * 
	 * @param text
	 * @param analyzer
	 * @return 失败：返回空List
	 */
	public static List<String> getTokenList(String text, Analyzer analyzer) {
		if (null == text || text.trim().isEmpty() || null == analyzer) {
			return new ArrayList<String>();
		}

		List<String> list = new ArrayList<String>();

		TokenStream ts = null;// 获取Lucene的TokenStream对象
		try {
			ts = analyzer.tokenStream(null, new StringReader(text));
			CharTermAttribute term = ts.addAttribute(CharTermAttribute.class);// 获取词元文本属性
			ts.reset(); // 重置TokenStream（重置StringReader）
			while (ts.incrementToken()) {// 迭代获取分词结果
				list.add(term.toString());
			}
			ts.end(); // Perform end-of-stream operations, e.g. set the final
						// offset.
		} catch (IOException e) {
			e.printStackTrace();
		} finally {
			if (ts != null) {// 释放TokenStream的所有资源
				try {
					ts.close();
				} catch (IOException e) {
					e.printStackTrace();
				}
			}
		}

		return list;
	}

	/**
	 * 构造短语查询
	 * 
	 * @param field
	 * @param keyword
	 * @param analyzer
	 * @return 失败：null
	 */
	public static PhraseQuery getPhraseQuery(String field, String keyword,
			Analyzer analyzer) {
		if (keyword == null || keyword.length() == 0) {
			return null;
		}

		try {
			// 得到分词词条
			List<String> wordList = getTokenList(keyword, analyzer);
			if (wordList.size() == 0) {
				return null;
			}
			// 构造短语查询
			PhraseQuery phraseQuery = new PhraseQuery();
			for (String word : wordList) {
				phraseQuery.add(new Term(field, word));
			}
			return phraseQuery;
		} catch (Exception e) {
			e.printStackTrace();
		}
		return null;
	}	
	
}

```

#####  SearchIndexService

创建索引、更新索引、搜索业务逻辑

```

import java.io.IOException;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import org.apache.commons.lang.StringUtils;
import org.apache.lucene.analysis.Analyzer;
import org.apache.lucene.document.Document;
import org.apache.lucene.document.Field;
import org.apache.lucene.document.IntField;
import org.apache.lucene.document.LongField;
import org.apache.lucene.index.IndexWriter;
import org.apache.lucene.search.BooleanClause;
import org.apache.lucene.search.BooleanClause.Occur;
import org.apache.lucene.search.BooleanQuery;
import org.apache.lucene.search.IndexSearcher;
import org.apache.lucene.search.MatchAllDocsQuery;
import org.apache.lucene.search.PhraseQuery;
import org.apache.lucene.search.Query;
import org.apache.lucene.search.ScoreDoc;
import org.apache.lucene.search.Sort;
import org.apache.lucene.search.SortField;
import org.apache.lucene.search.TopDocs;
import org.apache.lucene.search.highlight.Highlighter;
import org.apache.lucene.search.highlight.NullFragmenter;
import org.apache.lucene.search.highlight.QueryScorer;
import org.apache.lucene.search.highlight.SimpleHTMLFormatter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import com.sekorm.searchengine.common.constant.SearchConstant;
import com.sekorm.searchengine.model.PnPlS;
import com.sekorm.searchengine.model.SearchEcBean;
import com.sekorm.searchengine.model.SearchEcObj;
import com.sekorm.searchengine.searchutil.HtmlUtil;
import com.sekorm.searchengine.searchutil.IkHightLight;
import com.sekorm.searchengine.searchutil.QueryUtil;
import com.sekorm.searchengine.searchutil.SearchUtil;
import com.sekorm.searchengine.searchutil.SortUtil;
import com.sekorm.searchengine.vo.QuestionVO;
import com.sekorm.searchengine.vo.SearchEcObjVO;


/**
 * @describe  资讯搜索Service
 * @author bowen_bao
 * @date 2015年7月18日
 */
@Service
public class SearchIndexService {
	
	private final Logger log = LoggerFactory.getLogger(this.getClass());
	
	
	@Value("${file_url}")
	private String file_url;
	
	@Autowired
	private SearchUtil searchUtil;
	
	@Autowired
	private QueryUtil queryUtil;
	
	@Autowired
	private HtmlUtil htmlUtil ;
	
	@Autowired
	private SortUtil sortUtil;
	
	@Autowired
	private IkHightLight ikHightLight;
	
	
	@Autowired
	private EcNewPNService ecNewPNService;
	
	@Autowired
	private EcService ecService;
	
	/**
	 * @describe  创建或更新索引
	 *
	 * @author bowen_bao
	 * @date 2015年7月18日
	 * @param
	 * @return
	 */
	public boolean createOrUpdate(SearchEcObj ecobj){
		
		
		if(ecobj==null || ecobj.getIndexType()==null ||  "".equals(ecobj.getIndexType())){
			return false;
		}
		if("1".equals(ecobj.getIndexType())){
			if(ecobj.getEcNewid()==null  ||  ecobj.getEcNewid()==0 ){
				return false;
			}
		}
		if("2".equals(ecobj.getIndexType())){
			if(ecobj.getEcDocid()==null  ||  ecobj.getEcDocid()==0 ){
				return false;
			}
		}
		if("3".equals(ecobj.getIndexType())){
			if(ecobj.getQuestionid()==null  ||  ecobj.getQuestionid()==0 ){
				return false;
			}
		}
		try {
			IndexWriter  indexWriter=searchUtil.getIndexWriter();
			Document doc=new Document();
			
			Field indextypeField=new Field("indexType",ecobj.getIndexType(),SearchConstant.STORE_YES_ANALYZED_NO);
			doc.add(indextypeField);
			
			if(ecobj.getEcNewid()!=null){
				IntField ecnewidField=new IntField("ecNewid",ecobj.getEcNewid(),IntField.TYPE_STORED);
				doc.add(ecnewidField);
			}
			
			if(ecobj.getEcDocid()!=null){
				IntField ecdocidField=new IntField("ecDocid",ecobj.getEcDocid(),IntField.TYPE_STORED);
				doc.add(ecdocidField);
			}
			
			if(ecobj.getQuestionid()!=null){
				IntField ecdocidField=new IntField("questionid",ecobj.getQuestionid(),IntField.TYPE_STORED);
				doc.add(ecdocidField);
			}
			
			if(StringUtils.isNotEmpty(ecobj.getTitle())){
				Field titleField=new Field("title",ecobj.getTitle(),SearchConstant.STORE_YES_ANALYZED);
				doc.add(titleField);
			}
			if(StringUtils.isNotEmpty(ecobj.getSummary())){
				doc.add(new Field("summary",ecobj.getSummary(),SearchConstant.STORE_YES_ANALYZED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getDetail())){
				String detailStr=htmlUtil.extractTextData(ecobj.getDetail());
				if(StringUtils.isNotEmpty(detailStr)){
					doc.add(new Field("detail",detailStr,SearchConstant.STORE_YES_ANALYZED));
				}
			}
			
			if(StringUtils.isNotEmpty(ecobj.getSecretLevel())){
				doc.add(new Field("secretLevel",ecobj.getSecretLevel(),SearchConstant.STORE_YES_ANALYZED));
			}
			if(StringUtils.isNotEmpty(ecobj.getTouristFlag())){
				doc.add(new Field("touristFlag",ecobj.getTouristFlag(),SearchConstant.STORE_YES_ANALYZED));
			}
			
			if("1".equals(ecobj.getIndexType())){
				if(StringUtils.isNotEmpty(ecobj.getWebShow())){
					doc.add(new Field("webShow",ecobj.getWebShow(),SearchConstant.STORE_YES_ANALYZED));
				}
				if(StringUtils.isNotEmpty(ecobj.getAppShow())){
					doc.add(new Field("appShow",ecobj.getAppShow(),SearchConstant.STORE_YES_ANALYZED));
				}
			}else if("2".equals(ecobj.getIndexType())){
				doc.add(new Field("webShow","1",SearchConstant.STORE_YES_ANALYZED));
				doc.add(new Field("appShow","1",SearchConstant.STORE_YES_ANALYZED));
			}else if("3".equals(ecobj.getIndexType())){
				if(StringUtils.isNotEmpty(ecobj.getWebShow())){
					doc.add(new Field("webShow",ecobj.getWebShow(),SearchConstant.STORE_YES_ANALYZED));
				}
				if(StringUtils.isNotEmpty(ecobj.getAppShow())){
					doc.add(new Field("appShow",ecobj.getAppShow(),SearchConstant.STORE_YES_ANALYZED));
				}
			}
			
			if(StringUtils.isNotEmpty(ecobj.getImg1())){
				doc.add(new Field("img1",ecobj.getImg1(),SearchConstant.STORE_YES_ANALYZED_NO));
			}
			if(StringUtils.isNotEmpty(ecobj.getImg2())){
				doc.add(new Field("img2",ecobj.getImg2(),SearchConstant.STORE_YES_ANALYZED_NO));
			}
			if(StringUtils.isNotEmpty(ecobj.getImg3())){
				doc.add(new Field("img3",ecobj.getImg3(),SearchConstant.STORE_YES_ANALYZED_NO));
			}
			if(StringUtils.isNotEmpty(ecobj.getImg4())){
				doc.add(new Field("img4",ecobj.getImg4(),SearchConstant.STORE_YES_ANALYZED_NO));
			}
			if(StringUtils.isNotEmpty(ecobj.getImg5())){
				doc.add(new Field("img5",ecobj.getImg5(),SearchConstant.STORE_YES_ANALYZED_NO));
			}
			if(StringUtils.isNotEmpty(ecobj.getImg6())){
				doc.add(new Field("img6",ecobj.getImg6(),SearchConstant.STORE_YES_ANALYZED_NO));
			}
			if(StringUtils.isNotEmpty(ecobj.getImg7())){
				doc.add(new Field("img7",ecobj.getImg7(),SearchConstant.STORE_YES_ANALYZED_NO));
			}
			if(StringUtils.isNotEmpty(ecobj.getImg8())){
				doc.add(new Field("img8",ecobj.getImg8(),SearchConstant.STORE_YES_ANALYZED_NO));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getPublishTime())){
				doc.add(new Field("publishTime",ecobj.getPublishTime(),SearchConstant.STORE_YES_INDEX_NO));
				doc.add(new LongField("longpublishTime",searchUtil.DateStringToLong(ecobj.getPublishTime()),LongField.TYPE_STORED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getCreateTime())){
				doc.add(new Field("createTime",ecobj.getCreateTime(),SearchConstant.STORE_YES_INDEX_NO));
				doc.add(new LongField("longcreateTime",searchUtil.DateStringToLong(ecobj.getCreateTime()),LongField.TYPE_STORED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getUpdateTime())){
				doc.add(new Field("updateTime",ecobj.getUpdateTime(),SearchConstant.STORE_YES_INDEX_NO));
				doc.add(new LongField("longupdateTime",searchUtil.DateStringToLong(ecobj.getUpdateTime()),LongField.TYPE_STORED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getDocExt())){
				doc.add(new Field("docExt",ecobj.getDocExt(),SearchConstant.STORE_YES_ANALYZED_NO));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getKeyword())){
				doc.add(new Field("keyword",ecobj.getKeyword().toLowerCase(),SearchConstant.STORE_YES_ANALYZED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getBrandName())){
				doc.add(new Field("brandName",ecobj.getBrandName().toLowerCase(),SearchConstant.STORE_YES_ANALYZED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getGoodsName())){
				doc.add(new Field("goodsName",ecobj.getGoodsName().toLowerCase(),SearchConstant.STORE_YES_ANALYZED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getElecName())){
				doc.add(new Field("elecName",ecobj.getElecName().toLowerCase(),SearchConstant.STORE_YES_ANALYZED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getSname())){
				doc.add(new Field("sname",ecobj.getSname().toLowerCase(),SearchConstant.STORE_YES_ANALYZED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getPlName())){
				doc.add(new Field("plName",ecobj.getPlName().toLowerCase(),SearchConstant.STORE_YES_ANALYZED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getPnName())){
				doc.add(new Field("pnName",ecobj.getPnName().toLowerCase(),SearchConstant.STORE_YES_ANALYZED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getPnDescription())){
				doc.add(new Field("pnDescription",ecobj.getPnDescription(),SearchConstant.STORE_YES_ANALYZED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getPnResemblecode())){
				doc.add(new Field("pnResemblecode",ecobj.getPnResemblecode().toLowerCase(),SearchConstant.STORE_YES_ANALYZED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getFrontTime())){
				doc.add(new Field("frontTime",ecobj.getFrontTime(),SearchConstant.STORE_YES_ANALYZED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getPackageInfo())){
				doc.add(new Field("packageInfo",ecobj.getPackageInfo(),SearchConstant.STORE_YES_ANALYZED));
			}
			
			if(StringUtils.isNotEmpty(ecobj.getEctypeName())){
				doc.add(new Field("ectypeName",ecobj.getEctypeName(),SearchConstant.STORE_YES_ANALYZED_NO));
				
				if(SearchConstant.SEARCH_ectypeName_shujushouce.equals(ecobj.getEctypeName())){
					IntField sortEcField=new IntField("sortEc",1,IntField.TYPE_STORED);doc.add(sortEcField);
					IntField sortPnField=new IntField("sortPn",3,IntField.TYPE_STORED);doc.add(sortPnField);
				}else if(SearchConstant.SEARCH_ectypeName_xuanxinzhinan.equals(ecobj.getEctypeName())){
					IntField sortEcField=new IntField("sortEc",3,IntField.TYPE_STORED);doc.add(sortEcField);
					IntField sortPnField=new IntField("sortPn",2,IntField.TYPE_STORED);doc.add(sortPnField);
				}
				
			}
			
			if("1".equals(ecobj.getIndexType())){
				IntField sortEcField=new IntField("sortEc",2,IntField.TYPE_STORED);doc.add(sortEcField);
				IntField sortPnField=new IntField("sortPn",1,IntField.TYPE_STORED);doc.add(sortPnField);
			}
			
			
			
			//节约性能，直接删除后添加索引
			BooleanQuery query=new BooleanQuery();
			if("1".equals(ecobj.getIndexType())){
				Query queryid=queryUtil.getNumericRangeQuery("ecNewid", ecobj.getEcNewid());
				Query indextypeQ=queryUtil.getTermQuery("indexType",ecobj.getIndexType());
				query.add(queryid,Occur.MUST);
				query.add(indextypeQ,Occur.MUST);
			}else if("2".equals(ecobj.getIndexType())){
				Query queryid=queryUtil.getNumericRangeQuery("ecDocid", ecobj.getEcDocid());
				Query indextypeQ=queryUtil.getTermQuery("indexType",ecobj.getIndexType());
				query.add(queryid,Occur.MUST);
				query.add(indextypeQ,Occur.MUST);
			}else if("3".equals(ecobj.getIndexType())){
				Query queryid=queryUtil.getNumericRangeQuery("questionid", ecobj.getQuestionid());
				Query indextypeQ=queryUtil.getTermQuery("indexType",ecobj.getIndexType());
				query.add(queryid,Occur.MUST);
				query.add(indextypeQ,Occur.MUST);
			}
			searchUtil.getIndexWriter().deleteDocuments(query);
			
			indexWriter.addDocument(doc);
			
//			TODO： 这里并不去刷新IndexSearch
//			searchUtil.refreshSearch();
			
			return true;
		} catch (Exception e) {
			System.out.println(e.getStackTrace());
			log.error("EcNewIndexService create index error",e);
		}
		return false;
	}
	
	/**
	 * 更新资讯ID 删除索引
	 * @param id
	 * @return
	 */
	public boolean deleteByID(int id,String indextype){
		try {
//			searchUtil.getIndexWriter().deleteDocuments(new Term("id",id+""));
			BooleanQuery query=new BooleanQuery();
			if("1".equals(indextype)){
				Query queryid=queryUtil.getNumericRangeQuery("ecNewid", id);
				Query indextypeQ=queryUtil.getTermQuery("indexType",indextype);
				query.add(queryid,Occur.MUST);
				query.add(indextypeQ,Occur.MUST);
			}else if("2".equals(indextype)){
				Query queryid=queryUtil.getNumericRangeQuery("ecDocid", id);
				Query indextypeQ=queryUtil.getTermQuery("indexType",indextype);
				query.add(queryid,Occur.MUST);
				query.add(indextypeQ,Occur.MUST);
			}else if("3".equals(indextype)){
				Query queryid=queryUtil.getNumericRangeQuery("questionid", id);
				Query indextypeQ=queryUtil.getTermQuery("indexType",indextype);
				query.add(queryid,Occur.MUST);
				query.add(indextypeQ,Occur.MUST);
			}
			searchUtil.getIndexWriter().deleteDocuments(query);
			return true;
		} catch (IOException e) {
			log.error("EcNewIndexService deleteByID error"+e.getMessage());	
		}
		return false;
	}

	/**
	 * 删除所有索引
	 */
	public boolean deleteAll(){
		try {
			searchUtil.getIndexWriter().deleteAll();
			return true;
		} catch (IOException e) {
			log.error("EcNewIndexService deleteAll error:" + e.getMessage());
		}
		return false;
	}
	
	/**
	 * 获取索引库里面记录的总条数
	 * @return nCount
	 */
	public int getTotal(){
		Query matchAllDocsQuery=new MatchAllDocsQuery();
		try {
			TopDocs topDocs=searchUtil.getIndexSearcher().search(matchAllDocsQuery, 1);
			return topDocs.totalHits;
		} catch (IOException e) {
			log.error("EcNewIndexService getTotal() error :"+e.getMessage());
		}
		return 0;
	}
	
	/**
	 * 
	 * @describe 获取所有索引库的数据  测试专用
	 *
	 * @author bowen_bao
	 * @date 2015年9月8日
	 * @param
	 * @return
	 */
	public void showAll(){
		try {
			 for(int i=0;i<getTotal();i++){
				 Document doc=searchUtil.getIndexSearcher().doc(i);
				 System.out.println(doc.get("indexType")+"==="+doc.get("ecNewid")+"==="+doc.get("ecDocid")+"==="+doc.get("questionid"));
			 }
		} catch (Exception e) {
			log.error("EcNewIndexService showAll() error :"+e.getStackTrace());
		}
	}
	
	/**
	 * 通过id 找对象
	 * @param id
	 * @param indextype
	 * @return
	 */
	public  List<SearchEcObj> getByID(int id,String indextype){
		List<SearchEcObj> objlist=new ArrayList<SearchEcObj>();
		try {
			IndexSearcher search=searchUtil.getIndexSearcher();
			BooleanQuery query=new BooleanQuery();
			if("1".equals(indextype)){
				Query queryid=queryUtil.getNumericRangeQuery("ecNewid", id);
				Query indextypeQ=queryUtil.getTermQuery("indexType",indextype);
				query.add(queryid,Occur.MUST);
				query.add(indextypeQ,Occur.MUST);
			}else if("2".equals(indextype)){
				Query queryid=queryUtil.getNumericRangeQuery("ecDocid", id);
				Query indextypeQ=queryUtil.getTermQuery("indexType",indextype);
				query.add(queryid,Occur.MUST);
				query.add(indextypeQ,Occur.MUST);
			}else if("3".equals(indextype)){
				Query queryid=queryUtil.getNumericRangeQuery("questionid", id);
				Query indextypeQ=queryUtil.getTermQuery("indexType",indextype);
				query.add(queryid,Occur.MUST);
				query.add(indextypeQ,Occur.MUST);
			}
			TopDocs topdocs =search.search(query, Integer.MAX_VALUE);
			ScoreDoc[] scoreDocs=topdocs.scoreDocs;
			for(int i=0;i<scoreDocs.length;i++){
				SearchEcObj obj=new SearchEcObj();
				int doc=scoreDocs[i].doc;
				Document document=search.doc(doc);
				obj=documentToEcNew(document,obj);
				objlist.add(obj);
			}
		} catch (Exception e) {
			log.error("EcNewIndexService  getByID error" +e.getMessage());
		}
		return objlist;
	}
	
	/**
	 * 资讯高亮 原始版
	 * @param list
	 * @param query
	 */
	public void highLightv_1(List<SearchEcObjVO> list,Query query,String keyword){
		if(list==null ||  list.size()==0  ||  query==null){
			return ;
		}
		
		Highlighter highlighter=new Highlighter(new SimpleHTMLFormatter(SearchConstant.HIGHLIGHT_BEGIN,SearchConstant.HIGHLIGHT_END), new QueryScorer(query));
		highlighter.setTextFragmenter(new NullFragmenter());
		
		for(SearchEcObjVO ecnew:list){//只高亮title  summery
			ecnew.setTitle(highLight(ecnew.getTitle(),highlighter,searchUtil.getAnalyzer()));
			ecnew.setSummary(highLight(ecnew.getSummary(),highlighter,searchUtil.getAnalyzer()));
		}
	}
	
	
	
	public void highLight(List<SearchEcObjVO> list,String keyword){
		if(list==null ||  list.size()==0  ){
			return ;
		}
		
		ikHightLight.sekormhigh(list, keyword);
	}
	
	
	
	
	
	/**
	 * text  高亮
	 * @param text
	 * @param highlighter
	 * @param analyzer
	 * @return
	 */
	public String  highLight(String text,Highlighter highlighter,Analyzer analyzer){
		if(text==null ||  text.length()==0){
			return "";
		}
		try {
			String hlText=highlighter.getBestFragment(analyzer, null,text);
			if(hlText!=null){
				hlText=hlText.replace(SearchConstant.HIGHLIGHT_BEGIN+SearchConstant.HIGHLIGHT_END,"");
				return hlText;
			}else{
				return text;
			}
		} catch (Exception e) {
			log.error("EcNewIndexService highLight error:" +e.getMessage());
		} 
		return null;
	}
	
	
	/**
	 * @describe   资讯查询(搜索2.0总入口)
	 * @param  searchflag  web-0   andorid-1   ios-2{和RGC保持一致}
	 */
	public SearchEcBean ecSearch(String keyword,Integer pageNum,Integer pageSize,Integer memid,String searchflag,String imgFlag,String version,String type){
		
		Long starttime=(new Date()).getTime();
		SearchEcBean bean =new SearchEcBean();
		if(keyword==null ||  "".equals(keyword)){
			return null;
		}
		if(pageSize==null ||  0==pageSize){
			pageSize=SearchConstant.SEARCHPAGESIZE;
		}
		if(pageNum==null ||  0==pageNum){
			pageNum=1;
		}
		if(searchflag==null ||  "".equals(searchflag)){
			searchflag="0";
		}
		boolean blpn=false;
		List<SearchEcObjVO> list=new ArrayList<SearchEcObjVO>();
		try {
			BooleanQuery allQuery=new BooleanQuery(true);//全局总Query
			
			BooleanQuery blQuery=new BooleanQuery(true);//查询Query
			
			BooleanQuery showQuery=new BooleanQuery(true);//过滤Query
			if("0".equals(searchflag)){
				Query webQ=queryUtil.getTermQuery("webShow","1");
				showQuery.add(webQ,Occur.MUST);
			}else if("1".equals(searchflag)){
				Query appQ=queryUtil.getTermQuery("appShow","1");
				showQuery.add(appQ,Occur.MUST);
			}else if("2".equals(searchflag)){
				Query appQ=queryUtil.getTermQuery("appShow","1");
				showQuery.add(appQ,Occur.MUST);
			}else if("3".equals(searchflag)){
				Query webQ=queryUtil.getTermQuery("webShow","1");
				showQuery.add(webQ,Occur.MUST);
			}else{
				Query webQ=queryUtil.getTermQuery("webShow","1");
				showQuery.add(webQ,Occur.MUST);
			}
			
			if(memid==null || memid==0){
				Query memQ=queryUtil.getTermQuery("touristFlag","0");
				showQuery.add(memQ,Occur.MUST);
			} 
			 
			BooleanQuery secretQuery=new BooleanQuery(true);//保密级别过滤Query
			Query secretQ1=queryUtil.getTermQuery("secretLevel","1");
			secretQuery.add(secretQ1,Occur.SHOULD);
			Query secretQ2=queryUtil.getTermQuery("secretLevel","2");
			secretQuery.add(secretQ2,Occur.SHOULD);
			
			
			//判断用户是否为内部集
			if(ecService.isInsideMem(memid)){
				if("0".equals(searchflag) ||  (null!=version && !"".equals(version))){
					Query secretQ3=queryUtil.getTermQuery("secretLevel","3");
					secretQuery.add(secretQ3,Occur.SHOULD);
				}else{//老版本的APP
					Query vipQ=queryUtil.getTermQuery("secretLevel","3");
					showQuery.add(vipQ,Occur.MUST_NOT);
				}
			}else{
				Query vipQ=queryUtil.getTermQuery("secretLevel","3");
				showQuery.add(vipQ,Occur.MUST_NOT);
			}
			
			 
			if(!"0".equals(searchflag) &&  !"3".equals(searchflag) ){//之前的APP搜索，过滤掉pgc
				if(version==null || version.compareTo("2.0.0")<0 ){
					Query pgcQ=queryUtil.getTermQuery("indexType","3");
					showQuery.add(pgcQ,Occur.MUST_NOT);
				}
			}
			
			if("1".equals(type)){
				Query typeQ2=queryUtil.getTermQuery("indexType","2");
				showQuery.add(typeQ2,Occur.MUST_NOT);
				Query typeQ3=queryUtil.getTermQuery("indexType","3");
				showQuery.add(typeQ3,Occur.MUST_NOT);
			}else if("2".equals(type)){
				Query typeQ1=queryUtil.getTermQuery("indexType","1");
				showQuery.add(typeQ1,Occur.MUST_NOT);
				Query typeQ3=queryUtil.getTermQuery("indexType","3");
				showQuery.add(typeQ3,Occur.MUST_NOT);
			}else if("3".equals(type)){
				Query typeQ1=queryUtil.getTermQuery("indexType","1");
				showQuery.add(typeQ1,Occur.MUST_NOT);
				Query typeQ2=queryUtil.getTermQuery("indexType","2");
				showQuery.add(typeQ2,Occur.MUST_NOT);
			}
			
			//第一步：判断是否为对照类型(走搜索)
			List<String> pnList=getPnByKeyword(keyword);
			if(pnList!=null &&  pnList.size()>0){
				String pnStr=searchUtil.ListToString(pnList);
				Query pnQuery=ecNewPNService.pnsearch(pnStr);
				blQuery.add(pnQuery, Occur.SHOULD);
				blpn=true;
			}else{//不走对照型号反查PN的情况
					//走pn分支
				if(ecNewPNService.isPnName(keyword)||ecNewPNService.isPlName(keyword)||ecNewPNService.isSName(keyword)){
					Query pnQuery=ecNewPNService.pnsearch(keyword);
					blQuery.add(pnQuery, Occur.SHOULD);
					blpn=true;
				}else{
					//走全文检索
					//  ---------- title 全匹配  --------
					Query titleQuery=queryUtil.getKeywordPharseQuery("title", keyword, searchUtil.getAnalyzer(),0);
					if(titleQuery!=null){
						titleQuery.setBoost(SearchConstant.SEARCH_KEYWORD_FULL_TITLE_BOOST);
						blQuery.add(titleQuery, Occur.SHOULD);
					}
					//---------  摘要       |  pn描述   全匹配  ---------
					BooleanQuery blsummaryQuery=new BooleanQuery(true);
					Query summaryQuery=queryUtil.getKeywordPharseQuery("summary", keyword, searchUtil.getAnalyzer(),0);
					Query pnDescriptionQuery=queryUtil.getKeywordPharseQuery("pnDescription", keyword, searchUtil.getAnalyzer(),0);
					if(summaryQuery!=null){
						blsummaryQuery.add(summaryQuery, Occur.SHOULD);
					}
					if(pnDescriptionQuery!=null){
						blsummaryQuery.add(pnDescriptionQuery, Occur.SHOULD);
					}
					blsummaryQuery.setBoost(SearchConstant.SEARCH_KEYWORD_FULL_SUMMARY_BOOST);
					blQuery.add(blsummaryQuery, Occur.SHOULD);
					//---------  title  部分匹配 (50%以上)   --------------------
					Query titlePartMatchQuery1=queryUtil.getKeywordHalfMatchQuery("title", keyword, searchUtil.getAnalyzer(),true);
					if(titlePartMatchQuery1!=null){
						titlePartMatchQuery1.setBoost(SearchConstant.SEARCH_KEYWORD_PART1_TITLE_BOOST);
						blQuery.add(titlePartMatchQuery1, Occur.SHOULD);
					}
					
					//-----------------keyword 全匹配--------------------------------
					Query keywordQuery=queryUtil.getKeywordPharseQuery("keyword", keyword,searchUtil.getcommaAnalyzer(),0);
					if(keywordQuery!=null){
						keywordQuery.setBoost(SearchConstant.SEARCH_KEYWORD_FULL_KEYWORD_BOOST);
						blQuery.add(keywordQuery, Occur.SHOULD);
					}
					
					//------------------------正文全匹配-------------------------------
					Query detailQuery=queryUtil.getKeywordPharseQuery("detail", keyword, searchUtil.getAnalyzer(),0);
					if(detailQuery!=null){
						detailQuery.setBoost(SearchConstant.SEARCH_KEYWORD_FULL_DETAIL_BOOST);
						blQuery.add(detailQuery, Occur.SHOULD);
					}
					
					// -----------------------摘要(50%以上匹配)----------------------
					BooleanQuery blsummaryQuery1=new BooleanQuery(true);
					Query summaryPartMatchQuery1=queryUtil.getKeywordHalfMatchQuery("summary", keyword, searchUtil.getAnalyzer(),true);
					Query pnDescriptionQuery1=queryUtil.getKeywordHalfMatchQuery("pnDescription", keyword, searchUtil.getAnalyzer(),true);
					if(summaryPartMatchQuery1!=null){
						blsummaryQuery1.add(summaryPartMatchQuery1, Occur.SHOULD);
					}
					if(pnDescriptionQuery1!=null){
						blsummaryQuery1.add(pnDescriptionQuery1, Occur.SHOULD);
					}
					blsummaryQuery1.setBoost(SearchConstant.SEARCH_KEYWORD_PART1_SUMMARY_BOOST);
					blQuery.add(blsummaryQuery1, Occur.SHOULD);
					
					// -----------------------title(50%以下匹配)------------------------------------
					Query titlePartMatchQuery2=queryUtil.getKeywordHalfMatchQuery("title", keyword, searchUtil.getAnalyzer(),false);
					if(titlePartMatchQuery2!=null){
						titlePartMatchQuery2.setBoost(SearchConstant.SEARCH_KEYWORD_PART2_TITLE_BOOST);
						blQuery.add(titlePartMatchQuery2, Occur.SHOULD);
					}
					//------------------------市场应用(全匹配)------------------------------------------
					Query elecQuery=queryUtil.getTermQuery("elecName", keyword);
					if(elecQuery!=null){
						elecQuery.setBoost(SearchConstant.SEARCH_KEYWORD_FULL_ELEC_BOOST);
						blQuery.add(elecQuery, Occur.SHOULD);
					}
					//---------------------------正文匹配(50%以上)----------------------------------------------
					Query detailPartMatchQuery1=queryUtil.getKeywordHalfMatchQuery("detail", keyword, searchUtil.getAnalyzer(),true);
					if(detailPartMatchQuery1!=null){
						detailPartMatchQuery1.setBoost(SearchConstant.SEARCH_KEYWORD_PART1_DETAIL_BOOST);
						blQuery.add(detailPartMatchQuery1, Occur.SHOULD);
					}
					
					// -------------------------摘要(50%以下)-----------------------------------------------------
					BooleanQuery blsummaryQuery2=new BooleanQuery(true);
					Query summaryPartMatchQuery2=queryUtil.getKeywordHalfMatchQuery("summary", keyword, searchUtil.getAnalyzer(),false);
					Query pnDescriptionQuery2=queryUtil.getKeywordHalfMatchQuery("pnDescription", keyword, searchUtil.getAnalyzer(),false);
					if(summaryPartMatchQuery2!=null){
						blsummaryQuery2.add(summaryPartMatchQuery2, Occur.SHOULD);
					}
					if(pnDescriptionQuery2!=null){
						blsummaryQuery2.add(pnDescriptionQuery2, Occur.SHOULD);
					}
					blsummaryQuery2.setBoost(SearchConstant.SEARCH_KEYWORD_PART2_SUMMARY_BOOST);
					blQuery.add(blsummaryQuery2, Occur.SHOULD);
					
					// -------------------------正文(50%以下)-------------------------------------------------------------
					Query detailPartMatchQuery2=queryUtil.getKeywordHalfMatchQuery("detail", keyword, searchUtil.getAnalyzer(),false);
					if(detailPartMatchQuery2!=null){
						detailPartMatchQuery2.setBoost(SearchConstant.SEARCH_KEYWORD_PART2_DETAIL_BOOST);
						blQuery.add(detailPartMatchQuery2, Occur.SHOULD);
					}
				}
			}
			
			if(showQuery.clauses().size()>0){
				allQuery.add(showQuery, Occur.MUST);
			}
			allQuery.add(blQuery,Occur.MUST);
			allQuery.add(secretQuery,Occur.MUST);
			
			
			IndexSearcher indexSearch=searchUtil.getIndexSearcher();
			
			Sort sort=new Sort();
			if(blpn){
				SortField[] sortFields= sortUtil.getPnSort();
				sort.setSort(sortFields);
			}else{
				SortField[] sortFields= sortUtil.getEcnewSort();
				sort.setSort(sortFields);
			}
			
		
			TopDocs topdocs=indexSearch.search(allQuery, pageNum*pageSize,sort);
			int totalCount=topdocs.totalHits;
			ScoreDoc[] scoreDoc=topdocs.scoreDocs;
			
			//分页：
			if(pageNum==1){
				for(int i=0;i<(pageSize>totalCount?totalCount:pageSize);i++){
					list.add(documentToEcNewVO(indexSearch.doc(scoreDoc[i].doc),imgFlag,searchflag,0));
				}
			}else{
				int nsize=0;
				if(scoreDoc.length>=pageNum*pageSize){
					nsize=pageNum*pageSize;
				}else{
					nsize=scoreDoc.length;
				}
				for(int i=(pageNum-1)*pageSize;i<nsize;i++){
					list.add(documentToEcNewVO(indexSearch.doc(scoreDoc[i].doc),imgFlag,searchflag,0));
				}
			}
			 
			//高亮
			if("0".equals(searchflag)){
				highLight(list,keyword);
			}
			
			bean.setPageNum(pageNum);
			bean.setPageSize(pageSize);
			bean.setTotalCount(totalCount);
			bean.setResults(list);
			bean.setQ(keyword);
			Long endtime=(new Date()).getTime();
            bean.setqTime(Integer.parseInt(((endtime-starttime)+"")));
        	return bean;
		} catch (Exception e) {
			log.error(" EcNewIndexService  searchByObj  error :"+e);
		}
			bean.setPageNum(1);
			bean.setPageSize(pageSize);
			bean.setTotalCount(0);
			bean.setResults(list);
			bean.setQ(keyword);
			Long endtime=(new Date()).getTime();
	        bean.setqTime(Integer.parseInt(((endtime-starttime)+"")));
        
		return bean;
	}
	
	

	/**
	 * document  转   SearchEcObj (不对外)
	 * @param document
	 * @param ecnew
	 * @return
	 */
	public SearchEcObj documentToEcNew(Document document, SearchEcObj obj){
		
		obj.setIndexType(document.get("indexType"));
		
		if(StringUtils.isNotEmpty(document.get("ecNewid"))){
			obj.setEcNewid(Integer.parseInt(document.get("ecNewid")));
		}
		
		if(StringUtils.isNotEmpty(document.get("ecDocid"))){
			obj.setEcDocid(Integer.parseInt(document.get("ecDocid")));
		}
		
		if(StringUtils.isNotEmpty(document.get("questionid"))){
			obj.setQuestionid(Integer.parseInt(document.get("questionid")));
		}
		
		if(StringUtils.isNotEmpty(document.get("title"))){
			obj.setTitle(document.get("title"));
		}
		
		if(StringUtils.isNotEmpty(document.get("summary"))){
			obj.setSummary(document.get("summary"));
		}
		
		if(StringUtils.isNotEmpty(document.get("detail"))){
			obj.setDetail(document.get("detail"));
		}
		
		if(StringUtils.isNotEmpty(document.get("secretLevel"))){
			obj.setSecretLevel(document.get("secretLevel"));
		}
		
		if(StringUtils.isNotEmpty(document.get("touristFlag"))){
			obj.setTouristFlag(document.get("touristFlag"));
		}
		
		if(StringUtils.isNotEmpty(document.get("webShow"))){
			obj.setWebShow( document.get("webShow") );
		}
		if(StringUtils.isNotEmpty(document.get("appShow")) ){
			obj.setAppShow( document.get("appShow") );
		}
		
		if(StringUtils.isNotEmpty(document.get("img1"))){
			obj.setImg1(document.get("img1"));
		}
		if(StringUtils.isNotEmpty(document.get("img2"))){
			obj.setImg2(document.get("img2"));
		}
		
		if(StringUtils.isNotEmpty(document.get("img3"))){
			obj.setImg3(document.get("img3"));
		}
		if(StringUtils.isNotEmpty(document.get("img4"))){
			obj.setImg4(document.get("img4"));
		}
		
		if(StringUtils.isNotEmpty(document.get("img5"))){
			obj.setImg5(document.get("img5"));
		}
		
		if(StringUtils.isNotEmpty(document.get("img6"))){
			obj.setImg6(document.get("img6"));
		}
		if(StringUtils.isNotEmpty(document.get("img7"))){
			obj.setImg7(document.get("img7"));
		}
		if(StringUtils.isNotEmpty(document.get("img8"))){
			obj.setImg8(document.get("img8"));
		}
		
		if(StringUtils.isNotEmpty(document.get("publishTime"))){
			obj.setPublishTime(document.get("publishTime"));
			obj.setLongpublishTime(Long.parseLong(document.get("longpublishTime")));
		}
		
		if(StringUtils.isNotEmpty(document.get("createTime"))){
			obj.setCreateTime(document.get("createTime"));
			obj.setLongcreateTime(Long.parseLong(document.get("longcreateTime")));
		}
		
		if(StringUtils.isNotEmpty(document.get("updateTime"))){
			obj.setUpdateTime(document.get("updateTime"));
			obj.setLongupdateTime(Long.parseLong(document.get("longupdateTime")));
		}
			
		if(StringUtils.isNotEmpty(document.get("docExt"))){
			obj.setDocExt(document.get("docExt"));
		}
		
		if(StringUtils.isNotEmpty(document.get("keyword"))){
			obj.setKeyword(document.get("keyword"));
		}
		
		if(StringUtils.isNotEmpty(document.get("brandName"))){
			obj.setBrandName(document.get("brandName"));
		}
		
		if(StringUtils.isNotEmpty(document.get("goodsName"))){
			obj.setGoodsName(document.get("goodsName"));
		}
		
		if(StringUtils.isNotEmpty(document.get("elecName"))){
			obj.setElecName(document.get("elecName"));
		}
		
		if(StringUtils.isNotEmpty(document.get("sname"))){
			obj.setSname(document.get("sname"));
		}
		
		
		if(StringUtils.isNotEmpty(document.get("plName"))){
			obj.setPlName(document.get("plName"));
		}
		
		
		if(StringUtils.isNotEmpty(document.get("pnName"))){
			obj.setPnName(document.get("pnName"));
		}
		
		if(StringUtils.isNotEmpty(document.get("pnDescription"))){
			obj.setPnDescription(document.get("pnDescription"));
		}
		
		if(StringUtils.isNotEmpty(document.get("pnResemblecode"))){
			obj.setPnResemblecode(document.get("pnResemblecode"));
		}

		if(StringUtils.isNotEmpty(document.get("packageInfo"))){
			obj.setPackageInfo(document.get("packageInfo"));
		}

		if(StringUtils.isNotEmpty(document.get("ectypeName"))){
			obj.setEctypeName(document.get("ectypeName"));
		}
		
		if(StringUtils.isNotEmpty(document.get("sortEc"))){
			obj.setSortEc(Integer.parseInt(document.get("sortEc")));
		}
		
		if(StringUtils.isNotEmpty(document.get("sortPn"))){
			obj.setSortPn(Integer.parseInt(document.get("sortPn")));
		}
		
		return obj;
		
	}
	
	
	/**
	 * document  转   SearchEcObj(对外展示数据专用)
	 * @param document
	 * @param ecnew
	 * @return
	 */
	public SearchEcObjVO documentToEcNewVO(Document document,String imgFlag,String searchFlag,float indexScore){
		
		
		SearchEcObjVO obj=new SearchEcObjVO();
		obj.setIndexType(document.get("indexType"));
		
		if(StringUtils.isNotEmpty(document.get("ecNewid"))){
			obj.setEcNewid(Integer.parseInt(document.get("ecNewid")));
		}
		
		if(StringUtils.isNotEmpty(document.get("ecDocid"))){
			obj.setEcDocid(Integer.parseInt(document.get("ecDocid")));
		}
		
		if(StringUtils.isNotEmpty(document.get("questionid"))){
			obj.setQuestionid(Integer.parseInt(document.get("questionid")));
		}
		
		if(StringUtils.isNotEmpty(document.get("infoType"))){
			obj.setInfoType( document.get("infoType") );
		}
		
		if(StringUtils.isNotEmpty(document.get("title"))){
			obj.setTitle(document.get("title"));
		}
		
		if(StringUtils.isNotEmpty(document.get("docExt"))){
			obj.setDocExt(document.get("docExt"));
		}
		
		if(StringUtils.isNotEmpty(document.get("summary"))){
			obj.setSummary(document.get("summary"));
		}
		
		if(StringUtils.isNotEmpty(document.get("searchKeyword"))){
			obj.setSearchKeyword(document.get("searchKeyword"));
		}
		
		if(StringUtils.isEmpty(imgFlag)){
			imgFlag="2";
		}
		if(StringUtils.isEmpty(searchFlag)){
			searchFlag="0";
		}
		
		if("0".equals(searchFlag)){//web
			if("1".equals(obj.getIndexType())){
				if(document.get("img2")!=null ){
					obj.setImg(file_url+SearchConstant.ecnewimgpath+document.get("img2"));
				}else{
					obj.setImg("");
				}
			}
			if("2".equals(obj.getIndexType())){
				if(document.get("img2")!=null ){
					obj.setImg(file_url+SearchConstant.ecdocimgpath+document.get("img2"));
				}else{
					obj.setImg("");
				}
			}
		}else if("1".equals(searchFlag)){//手机 android
			if("1".equals(obj.getIndexType())){
				if("2".equals(imgFlag)){
					obj.setImg(file_url+SearchConstant.ecnewimgpath+document.get("img5"));
				}else{
					obj.setImg(file_url+SearchConstant.ecnewimgpath+document.get("img"+imgFlag));
				}
			}
			if("2".equals(obj.getIndexType())){
				if("2".equals(imgFlag)){
					obj.setImg(file_url+SearchConstant.ecdocimgpath+document.get("img5"));
				}else{
					obj.setImg(file_url+SearchConstant.ecdocimgpath+document.get("img"+imgFlag));
				}
			}
		}else if("2".equals(searchFlag)){//手机 ios
			if("1".equals(obj.getIndexType())){
				if("2".equals(imgFlag)){
					obj.setImg(file_url+SearchConstant.ecnewimgpath+document.get("img6"));
				}else{
					obj.setImg(file_url+SearchConstant.ecnewimgpath+document.get("img"+imgFlag));
				}
			}
			if("2".equals(obj.getIndexType())){
				if("2".equals(imgFlag)){
					obj.setImg(file_url+SearchConstant.ecdocimgpath+document.get("img6"));
				}else{
					obj.setImg(file_url+SearchConstant.ecdocimgpath+document.get("img"+imgFlag));
				}
			}
		}else{
			if("1".equals(obj.getIndexType())){
				if(document.get("img2")!=null ){
					obj.setImg(file_url+SearchConstant.ecnewimgpath+document.get("img2"));
				}else{
					obj.setImg("");
				}
			}
			if("2".equals(obj.getIndexType())){
				if(document.get("img2")!=null ){
					obj.setImg(file_url+SearchConstant.ecdocimgpath+document.get("img2"));
				}else{
					obj.setImg("");
				}
			}
		}
		
		
		if(document.get("publishTime")!=null){
			obj.setPublishTime(document.get("publishTime"));
		}else{
			obj.setPublishTime("");
		}
		
		if(document.get("createTime")!=null &&  !"".equals(document.get("createTime"))){
			obj.setCreateTime(document.get("createTime"));
		}else{
			obj.setCreateTime("");
		}
		if(document.get("updateTime")!=null && !"".equals(document.get("updateTime")) ){
			obj.setUpdateTime(document.get("updateTime"));
		}else{
			obj.setUpdateTime("");
		}
		
		
		if(document.get("frontTime")!=null && !"".equals(document.get("frontTime")) ){
			obj.setFrontTime(document.get("frontTime"));
		}else{
			obj.setFrontTime("");
		}
		
		if(document.get("secretLevel")!=null && !"".equals(document.get("secretLevel"))){
			obj.setSecretLevel(document.get("secretLevel"));
		}else{
			obj.setSecretLevel("");
		}
		
		
		if(document.get("sortEc")!=null && !"".equals(document.get("sortEc"))){
			obj.setSortEc(Integer.parseInt(document.get("sortEc")));
		}else{
			obj.setSortEc(0);
		}
		
		
		if(document.get("sortPn")!=null && !"".equals(document.get("sortPn"))){
			obj.setSortPn(Integer.parseInt(document.get("sortPn")));
		}else{
			obj.setSortPn(0);
		}
		
		if(document.get("ectypeName")!=null && !"".equals(document.get("ectypeName"))){
			obj.setEctypeName(document.get("ectypeName"));
		}else{
			obj.setEctypeName("");
		}
		
		obj.setIndexScore(indexScore);
		
		return obj;
		
	}
	
	

	
	
	/**
	 * @describe   通过keyword 判断是否是对照型号，找到对应PN
	 */
	public List<String> getPnByKeyword(String keyword){
		List<String> pnList=new ArrayList<String>();
//		Query query=queryUtil.getPartHitQuery("pnResemblecode", keyword.toLowerCase(),searchUtil.getcommaAnalyzer());
//		BooleanQuery blQ=new BooleanQuery(true);
//		blQ.add(query,Occur.MUST);
//		try {
//			TopDocs topdocs=searchUtil.getIndexSearcher().search(blQ, Integer.MAX_VALUE);
//			int totalCount=topdocs.totalHits;
//			ScoreDoc[] scoreDoc=topdocs.scoreDocs;
//			for(int i=0;i<totalCount;i++){
//				if(searchUtil.getIndexSearcher().doc(scoreDoc[i].doc)!=null && 
//						searchUtil.getIndexSearcher().doc(scoreDoc[i].doc).get("pnName")!=null &&
//						!"".equals(searchUtil.getIndexSearcher().doc(scoreDoc[i].doc).get("pnName"))){
//					pnList.add(searchUtil.getIndexSearcher().doc(scoreDoc[i].doc).get("pnName"));
//				}
//			}
//		} catch (IOException e) {
//			log.error("getPnByKeyword error",e);
//		}
		
		//在数据库里面找
		List<PnPlS> list=ecNewPNService.getPnPlSList();
		for(PnPlS obj:list){
			if(obj.getListresemble_code()!=null &&  obj.getListresemble_code().size()>0){
				for(String s:obj.getListresemble_code()){
					if(keyword.toLowerCase().equals(s.toLowerCase())){
						if(!pnList.contains(obj.getPnName())){
							pnList.add(obj.getPnName());
						}
					}
				}
			}
		}
		
		return pnList;
	}
	
	//*********************************************************************** 非业务
	 
	
	/**
	 * 
	 * @describe   测试短语查询
	 *
	 * @author bowen_bao
	 * @date 2015年7月23日
	 * @param
	 * @return
	 */
	public List<SearchEcObj> testsearch(String searchkeyword){
		
		if(searchkeyword==null ||  "".equals(searchkeyword)){
			return null;
		}
		List<SearchEcObj> list=new ArrayList<SearchEcObj>();
		try {
			IndexSearcher indexSearch=searchUtil.getIndexSearcher();
			
			BooleanQuery blQuery=new BooleanQuery(true);
			
			PhraseQuery fieldQuery1=queryUtil.getPhraseQuery("title", searchkeyword, searchUtil.getAnalyzer(),0);
			fieldQuery1.setBoost(2.0f);
			PhraseQuery fieldQuery2=queryUtil.getPhraseQuery("keyword", searchkeyword, searchUtil.getAnalyzer(),0);
			
			if(fieldQuery1!=null){
//				blQuery.add(fieldQuery1,BooleanClause.Occur.MUST);
				blQuery.add(fieldQuery1,BooleanClause.Occur.SHOULD);
				
			}
			if(fieldQuery2!=null){
//				blQuery.add(fieldQuery2,BooleanClause.Occur.MUST);
				blQuery.add(fieldQuery2,BooleanClause.Occur.SHOULD);
			}
			
			
			Sort sort=new Sort();
			SortField[] sortFields=sortUtil.getEcnewSort();
			
			sort.setSort(sortFields);
			TopDocs topdocs=indexSearch.search(blQuery, 10,sort);
			
			
			int totalCount=topdocs.totalHits;
			ScoreDoc[] scoreDoc=topdocs.scoreDocs;
			 
				for(int i=0;i<totalCount;i++){
					SearchEcObj searchEcNew=new SearchEcObj();
					int doc=scoreDoc[i].doc;
					
					Document document=indexSearch.doc(doc);
					
					searchEcNew=documentToEcNew(document,searchEcNew);
					
//					System.out.println("权重："+searchEcNew.getId()+":"+scoreDoc[i].score);
					
					list.add(searchEcNew);
				}
			 
			
		} catch (Exception e) {
			log.error(" EcNewIndexService  searchByObj  error :"+e.getMessage());
		}
		return list;
	}
	
	public List<SearchEcObj> testFullHitQuery(String searchkeyword){
		
		if(searchkeyword==null ||  "".equals(searchkeyword)){
			return null;
		}
		List<SearchEcObj> list=new ArrayList<SearchEcObj>();
		try {
			IndexSearcher indexSearch=searchUtil.getIndexSearcher();
			
			
			Query fieldQuery1=queryUtil.getFullHitQuery("detail", searchkeyword, searchUtil.getAnalyzer());
			
			
			
			Sort sort=new Sort();
			SortField[] sortFields=new SortField[]{
				SortField.FIELD_SCORE,new SortField("longupdateTime", SortField.Type.LONG,true)	
			};
			
			sort.setSort(sortFields);
			TopDocs topdocs=indexSearch.search(fieldQuery1, 10,sort);
			
			
			int totalCount=topdocs.totalHits;
			ScoreDoc[] scoreDoc=topdocs.scoreDocs;
			 
				for(int i=0;i<totalCount;i++){
					SearchEcObj searchEcNew=new SearchEcObj();
					int doc=scoreDoc[i].doc;
					
					Document document=indexSearch.doc(doc);
					
					searchEcNew=documentToEcNew(document,searchEcNew);
					
					list.add(searchEcNew);
				}
			 
			
		} catch (Exception e) {
			log.error(" EcNewIndexService  searchByObj  error :"+e.getMessage());
		}
		return list;
	}
	
	public List<SearchEcObj> testPartHitQuery(String searchkeyword){
			
			if(searchkeyword==null ||  "".equals(searchkeyword)){
				return null;
			}
			List<SearchEcObj> list=new ArrayList<SearchEcObj>();
			try {
				IndexSearcher indexSearch=searchUtil.getIndexSearcher();
				
				
				Query fieldQuery1=queryUtil.getPartHitQuery("title", searchkeyword, searchUtil.getAnalyzer());
				
				
				
				Sort sort=new Sort();
				SortField[] sortFields=new SortField[]{
					SortField.FIELD_SCORE,new SortField("longupdateTime", SortField.Type.LONG,true)	
				};
				
				sort.setSort(sortFields);
				TopDocs topdocs=indexSearch.search(fieldQuery1, 10,sort);
				
				
				int totalCount=topdocs.totalHits;
				ScoreDoc[] scoreDoc=topdocs.scoreDocs;
				 
					for(int i=0;i<totalCount;i++){
						SearchEcObj searchEcNew=new SearchEcObj();
						int doc=scoreDoc[i].doc;
						
						Document document=indexSearch.doc(doc);
						
						searchEcNew=documentToEcNew(document,searchEcNew);
						
						list.add(searchEcNew);
					}
				 
				
			} catch (Exception e) {
				log.error(" EcNewIndexService  searchByObj  error :"+e.getMessage());
			}
			return list;
		}

	public List<SearchEcObj> queryToListOBJ(Query query,Sort sort,Integer pageSize,Integer pageNum){
		
		List<SearchEcObj> list=new ArrayList<SearchEcObj>();
		TopDocs topdocs;
		try {
			topdocs = searchUtil.getIndexSearcher().search(query,Integer.MAX_VALUE,sort);
//			int totalCount=topdocs.totalHits;
			ScoreDoc[] scoreDoc=topdocs.scoreDocs;
			 
				for(int i=0;i<scoreDoc.length;i++){
					SearchEcObj searchEcNew=new SearchEcObj();
					int doc=scoreDoc[i].doc;
					
					Document document=searchUtil.getIndexSearcher().doc(doc);
					
					searchEcNew=documentToEcNew(document,searchEcNew);
					 
					System.out.println("权重："+searchEcNew.getEcNewid()+"============:"+ searchUtil.getIndexSearcher().explain(query, doc)   );
					
					list.add(searchEcNew);
				}
				return list;
		} catch (Exception e) {
			e.printStackTrace();
		}
		return list;
	}
	
	
	 public List<QuestionVO> getQuestionTitle(String keyword,String searchflag,Integer pageNum){
		  
			if(keyword==null ||  "".equals(keyword)){
				return null;
			}
			 
			try {
				BooleanQuery allQuery=new BooleanQuery(true);//全局总Query
				
				BooleanQuery blQuery=new BooleanQuery(true);//查询Query
				
				BooleanQuery showQuery=new BooleanQuery(true);//过滤Query
				if("0".equals(searchflag)|| "3".equals(searchflag)){
					Query webQ=queryUtil.getTermQuery("webShow","1");
					showQuery.add(webQ,Occur.MUST);
				}else if("1".equals(searchflag)||"2".equals(searchflag)){
					Query appQ=queryUtil.getTermQuery("appShow","1");
					showQuery.add(appQ,Occur.MUST);
				}else{
					Query webQ=queryUtil.getTermQuery("webShow","1");
					showQuery.add(webQ,Occur.MUST);
				}
				 
				BooleanQuery secretQuery=new BooleanQuery(true);//保密级别过滤Query
				Query secretQ1=queryUtil.getTermQuery("secretLevel","1");
				secretQuery.add(secretQ1,Occur.SHOULD);
				Query secretQ2=queryUtil.getTermQuery("secretLevel","2");
				secretQuery.add(secretQ2,Occur.SHOULD);
				 
				Query pgcQ=queryUtil.getTermQuery("indexType","3");
				showQuery.add(pgcQ,Occur.MUST);
				
				Query titleQuery=queryUtil.getQuestionTitleQuery("title", keyword, searchUtil.getAnalyzer());
				if(titleQuery!=null){
					blQuery.add(titleQuery, Occur.SHOULD);
				}
						
				
				if(showQuery.clauses().size()>0){
					allQuery.add(showQuery, Occur.MUST);
				}
				allQuery.add(blQuery,Occur.MUST);
				allQuery.add(secretQuery,Occur.MUST);
				
				IndexSearcher indexSearch=searchUtil.getIndexSearcher();
			
				
				
//				TopDocs topdocs=indexSearch.search(allQuery, pageNum*pageSize,sort);
//				int totalCount=topdocs.totalHits;
//				ScoreDoc[] scoreDoc=topdocs.scoreDocs;
//				
//				//分页：
//				if(pageNum==1){
//					for(int i=0;i<(pageSize>totalCount?totalCount:pageSize);i++){
//						list.add(documentToEcNewVO(indexSearch.doc(scoreDoc[i].doc),imgFlag,searchflag,0));
//					}
//				}else{
//					int nsize=0;
//					if(scoreDoc.length>=pageNum*pageSize){
//						nsize=pageNum*pageSize;
//					}else{
//						nsize=scoreDoc.length;
//					}
//					for(int i=(pageNum-1)*pageSize;i<nsize;i++){
//						list.add(documentToEcNewVO(indexSearch.doc(scoreDoc[i].doc),imgFlag,searchflag,0));
//					}
//				}
				
				
				TopDocs topdocs=indexSearch.search(allQuery,SearchConstant.QUESTIONPAGESIZE*pageNum);
				int totalCount=topdocs.totalHits;
				ScoreDoc[] scoreDoc=topdocs.scoreDocs;
				
				List<QuestionVO> list=new ArrayList<QuestionVO>();
				
				
				//分页：
				if(pageNum==1){
					 QuestionVO vo;
					 Document document=null;
					for(int i=0;i<(SearchConstant.QUESTIONPAGESIZE>totalCount?totalCount:SearchConstant.QUESTIONPAGESIZE);i++){
							vo=new QuestionVO();
							document=indexSearch.doc(scoreDoc[i].doc);
							vo.setTitle(document.get("title"));
							vo.setId(Integer.parseInt(document.get("questionid")));
							list.add(vo);
					}
				}else{
					int nsize=0;
					if(scoreDoc.length>=pageNum*SearchConstant.QUESTIONPAGESIZE){
						nsize=pageNum*SearchConstant.QUESTIONPAGESIZE;
					}else{
						nsize=scoreDoc.length;
					}
					 QuestionVO vo;
					 Document document=null;
					for(int i=(pageNum-1)*SearchConstant.QUESTIONPAGESIZE;i<nsize;i++){
						vo=new QuestionVO();
						document=indexSearch.doc(scoreDoc[i].doc);
						vo.setTitle(document.get("title"));
						vo.setId(Integer.parseInt(document.get("questionid")));
						list.add(vo);
					}
				}
				
				
//				if(scoreDoc!=null&& scoreDoc.length>0 ){
//					 
//					 Document document=null;
//					 int nCount=scoreDoc.length;
//					 if(nCount>10){
//						 nCount=10; 
//					 }
//					 
//					 QuestionVO vo;
//					for(int i=0;i<nCount;i++){
//						vo=new QuestionVO();
//						document=indexSearch.doc(scoreDoc[i].doc);
//						vo.setTitle(document.get("title"));
//						vo.setId(Integer.parseInt(document.get("questionid")));
//						list.add(vo);
//					}
//				}
				return list;
			 
			} catch (Exception e) {
				log.error(" getTitle  error :"+e);
			}
			 
	    	return null;
	    }
	
}

```


#####   IndexService

job来调取，定时更新索引库


```
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.Date;
import java.util.List;
import java.util.Properties;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import com.sekorm.common.util.DateTimeUtils;
import com.sekorm.common.util.StringUtils;
import com.sekorm.searchengine.model.SearchEcObj;
import com.sekorm.searchengine.searchutil.SearchUtil;


/**
 * @describe  Index Service
 */
@Service
public class IndexService {
	
	private static final Logger log = LoggerFactory.getLogger(IndexService.class);
	
	@Autowired
	private SearchIndexService  searchIndexService;
	
	@Autowired
	private EcService  ecService;
	
	@Autowired
	private SearchUtil  searchUtil;
	
	/**
	 * 全量索引
	 */
	public void fullIndex() {
		List<SearchEcObj> list=ecService.getSearchEcObjs();
		if(list!=null && list.size()>0){
			searchIndexService.deleteAll();
			for(SearchEcObj obj:list){
				searchIndexService.createOrUpdate(obj);
			}
			searchUtil.refreshSearch();
		}
	}
	
	/**
	 * 增量索引
	 */
	public void increaseIndex() {
		Date now=new Date();
		String key = "lastUpdateTime";
		String path = Thread.currentThread().getContextClassLoader().getResource("").getPath() + "system.properties";
		String lastUpdateTime = getProperties(path, key);
		if (StringUtils.isBlank(lastUpdateTime)) {
			writeProperties(path, key, DateTimeUtils.getDateTime(new Date()));
		}
		List<SearchEcObj> list = ecService.getIncremented(lastUpdateTime);
		for (SearchEcObj obj : list) {
			searchIndexService.createOrUpdate(obj);
		}
		searchUtil.refreshSearch();
		//把最新事件同步到配置文件
		String timeNow=DateTimeUtils.getDateTime(now);
		writeProperties(path,key,timeNow);
	}
	
	//写入properties信息
  	private static void writeProperties(String filePath,String parameterName,String parameterValue) {
  		Properties prop = new Properties();
  		try {
  			InputStream fis = new FileInputStream(filePath);
  			//从输入流中读取属性列表（键和元素对）
  			prop.load(fis);
  			//调用 Hashtable 的方法 put。使用 getProperty 方法提供并行性。
  			//强制要求为属性的键和值使用字符串。返回值是 Hashtable 调用 put 的结果。
  			OutputStream fos = new FileOutputStream(filePath);
  			prop.setProperty(parameterName, parameterValue);
  			//以适合使用 load 方法加载到 Properties 表中的格式，
  			//将此 Properties 表中的属性列表（键和元素对）写入输出流
  			prop.store(fos, "Update '" + parameterName + "' value");
  		} catch (IOException e) {
  			log.error("Visit " + filePath + " for updating " + parameterName + " value error",e);
  		}
  	}

  	synchronized static private String getProperties(String fileName,String key){
  		Properties prop = new Properties();
  		try {
  			InputStream fis = new FileInputStream(fileName);
  			prop.load(fis);
  			return prop.getProperty(key);
  		} catch (IOException e) {
  			log.error("getProperties error===",e);
  		}
  		return null;
  	}

}

```


#####   AnalyzerController 

测试分词效果

```

import java.io.IOException;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.List;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.lucene.analysis.Analyzer;
import org.apache.lucene.analysis.TokenStream;
import org.apache.lucene.analysis.tokenattributes.CharTermAttribute;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.wltea.analyzer.lucene.IKAnalyzer;
import com.sekorm.searchengine.common.MainController;

/**
 * 
 * @describe 做敏感词专用
 *
 * @author bowen_bao
 * @date 2015年9月8日
 */
@Controller
@RequestMapping(value = "/analyzer", produces = "application/json;;charset=UTF-8")
public class AnalyzerController extends MainController {

    private static Logger logger = LoggerFactory.getLogger(AnalyzerController.class);
    
    
    
    /**
     * 
     * @describe  查看分词
     *
     * @author bowen_bao
     * @date 2015年9月8日
     * @param
     * @return
     */
    @RequestMapping(value = "/query")
    @ResponseBody
    public List<String> getAnalyzer(String q,HttpServletRequest request, HttpServletResponse response) {
    	
    	List<String> list=new ArrayList<String>();
    	String text=q;
		Analyzer anal=new IKAnalyzer();
		StringReader reader=new StringReader(text);
		try {
			if(text.length()>1){
				TokenStream ts=anal.tokenStream("", reader);
				CharTermAttribute term=ts.getAttribute(CharTermAttribute.class);
				ts.reset();
				while(ts.incrementToken()){
					list.add(term.toString());
				}
			}else{
				list.add(text);
			}
			anal.close();
			reader.close();
		} catch (IOException e) {
			logger.error("AnalyzerController getAnalyzer error:",e);
		}
    	return list;
    }
    
}

```


#####    TestIndexController

URL 刷新索引库

```

import java.io.IOException;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.lucene.analysis.Analyzer;
import org.apache.lucene.analysis.TokenStream;
import org.apache.lucene.analysis.tokenattributes.CharTermAttribute;
import org.apache.lucene.document.Document;
import org.apache.lucene.search.BooleanClause.Occur;
import org.apache.lucene.search.BooleanQuery;
import org.apache.lucene.search.NumericRangeQuery;
import org.apache.lucene.search.Query;
import org.apache.lucene.search.ScoreDoc;
import org.apache.lucene.search.TopDocs;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.wltea.analyzer.lucene.IKAnalyzer;
import com.sekorm.searchengine.common.MainController;
import com.sekorm.searchengine.model.SearchEcObj;
import com.sekorm.searchengine.searchutil.QueryUtil;
import com.sekorm.searchengine.searchutil.SearchUtil;
import com.sekorm.searchengine.service.EcService;
import com.sekorm.searchengine.service.MemberKeywordService;
import com.sekorm.searchengine.service.PnPlSService;
import com.sekorm.searchengine.service.SearchIndexService;

/**
 * 
 * @describe 辅助管理索引
 *
 * @author bowen_bao
 * @date 2015年9月8日
 */
@Controller
@RequestMapping(value = "/test", produces = "application/json;;charset=UTF-8")
public class TestIndexController extends MainController {

    private static Logger logger = LoggerFactory.getLogger(TestIndexController.class);

    @Autowired
    private MemberKeywordService memberKeywordService;
    
    @Autowired
    private SearchIndexService searchIndexService;
    
    @Autowired
    private QueryUtil queryUtil;
    
    @Autowired
    private SearchUtil searchUtil;
    
    @Autowired
    private EcService ecService;
    
    @Autowired
    private PnPlSService pnplsService;
    
    @Value("${rgc_path}")
	private String rgc_path;
    
   /**
    * 
    * @describe 按类型查询资讯|资料
    *
    * @author bowen_bao
    * @date 2015年9月8日
    * @param   q: 1-资讯 2-资料
    * @return  索引库里面的条数
    */
    @RequestMapping(value = "/query")
    @ResponseBody
    public Integer searchIndexTypeNum(String q,HttpServletRequest request, HttpServletResponse response) {
    	
    	int n=0;
    	BooleanQuery query=new BooleanQuery();
    	if(q==null || "".equals(q)){
    		Query indextypeQ1=queryUtil.getTermQuery("indexType","1");
    		Query indextypeQ2=queryUtil.getTermQuery("indexType","2");
    		query.add(indextypeQ1,Occur.SHOULD);
    		query.add(indextypeQ2,Occur.SHOULD);
    	}else{
    		Query indextypeQ1=queryUtil.getTermQuery("indexType",q);
    		query.add(indextypeQ1,Occur.SHOULD);
    	}
		
		TopDocs topdocs;
		try {
			topdocs = searchUtil.getIndexSearcher().search(query, Integer.MAX_VALUE);
			ScoreDoc[] scoreDocs=topdocs.scoreDocs;
			n=scoreDocs.length;
		} catch (IOException e) {
			logger.error("searchIndexTypeNum error===",e);
		}
    	return n;
    }
    
    /**
     * 
     * @describe  查看分词
     *
     * @author bowen_bao
     * @date 2015年9月8日
     * @param
     * @return
     */
    @RequestMapping(value = "/analyzer")
    @ResponseBody
    public String getAnalyzer(String q,HttpServletRequest request, HttpServletResponse response) {
    	
    	String str="";
    	String text=q;
		Analyzer anal=new IKAnalyzer();//true: 确定是词元后不在细分
		StringReader reader=new StringReader(text);
		TokenStream ts=null;
		try {
			if(text.length()>1){
				ts=anal.tokenStream("", reader);
				CharTermAttribute term=ts.getAttribute(CharTermAttribute.class);
				ts.reset();
				while(ts.incrementToken()){
					 Pattern intP =Pattern.compile("[0-9]");
					 Pattern strP =Pattern.compile("[a-zA-Z]");
					 if(!intP.matcher(term.toString()).matches()&& !strP.matcher(term.toString()).matches()){
							String regEx="[\\u4e00-\\u9fa5]";
							Pattern p=Pattern.compile(regEx);
							Matcher m=p.matcher(term.toString());
							int nCount=0;
							while(m.find()){
								 for(int i=0;i<=m.groupCount();i++){
									 nCount++;
								 }
							}
							if(nCount!=1){
								str+=term.toString()+"|";
							}
					 } 
				}
			}else{
				str=text;
			}
			
			anal.close();
			reader.close();
		} catch (IOException e) {
			e.printStackTrace();
		}finally{
			if(ts!=null){
				try {
					ts.close();
				} catch (IOException e) {
					logger.error("TestIndexController getAnalyzer ts close error",e);
				}
			}
		}
		
    	return str;
    }
    
    /**
     * 
     * @describe 更新索引库
     *
     * @author bowen_bao
     * @date 2015年9月8日
     * @param
     * @return
     */
    @RequestMapping(value = "/refresh")
    @ResponseBody
    public String refreshSearch(){
    	
    	List<SearchEcObj> list=ecService.getSearchEcObjs();
		for(SearchEcObj obj:list){
			searchIndexService.createOrUpdate(obj);
		}
		
    	searchUtil.refreshSearch();
    	
    	
    	pnplsService.readGoodsToRAM();
    	
    	return  "OK";
    }
    
    
    
    
    /**
     * 
     * @describe 更新索引库
     *
     * @author bowen_bao
     * @date 2015年9月8日
     * @param
     * @return
     */
    @RequestMapping(value = "/refreshjob")
    @ResponseBody
    public String refreshjob(){
    	
    	pnplsService.readGoodsToRAM();
    	
    	return  "OK";
    }
    
    
    
    
   /**
    * 
    * @describe 测试获取后台数据
    *
    * @author bowen_bao
    * @date 2015年9月8日
    * @param
    * @return
    */
    @RequestMapping(value = "/allList")
    @ResponseBody
    public List<SearchEcObj> allList(){
    	
    	List<SearchEcObj> list=ecService.getSearchEcObjs();
		for(SearchEcObj obj:list){
			 System.out.println(obj.getIndexType()+"|"+obj.getEcNewid()+"|"+obj.getEcDocid()+"|");
		}
		return  list;
    }
    
    /**
     * 
     * @describe  通过资讯|资料ID 来查询
     *
     * @author bowen_bao
     * @date 2015年9月8日
     * @param q 类型：1-资讯  2-资料
     * @param id  资讯|资料ID
     * @return
     */
    @RequestMapping(value = "/getid")
    @ResponseBody
    public List<SearchEcObj> getid(String q,Integer id,HttpServletRequest request, HttpServletResponse response){
    	
    	List<SearchEcObj> list=new ArrayList<SearchEcObj>();
    	BooleanQuery query=new BooleanQuery();
     
    		Query indextypeQ1=queryUtil.getTermQuery("indexType",q);
    		query.add(indextypeQ1,Occur.MUST);
    		
    		if("1".equals(q)){
    			Query ecNewididQ=NumericRangeQuery.newIntRange("ecNewid", id, id, true, true);
        		query.add(ecNewididQ,Occur.MUST);
    		}else if("2".equals(q)){
    			Query ecDocidQ=NumericRangeQuery.newIntRange("ecDocid", id, id, true, true);
        		query.add(ecDocidQ,Occur.MUST);
    		}else if("3".equals(q)){
    			Query ecDocidQ=NumericRangeQuery.newIntRange("questionid", id, id, true, true);
        		query.add(ecDocidQ,Occur.MUST);
    		}
		
		TopDocs topdocs;
		try {
			topdocs = searchUtil.getIndexSearcher().search(query, 1);
			ScoreDoc[] scoreDocs=topdocs.scoreDocs;
			for(int i=0;i<scoreDocs.length;i++){
				SearchEcObj obj=new SearchEcObj();
				int doc=scoreDocs[i].doc;
				Document document=searchUtil.getIndexSearcher().doc(doc);
				obj=searchIndexService.documentToEcNew(document,obj);
				list.add(obj);
			}
		} catch (IOException e) {
			e.printStackTrace();
		}
    	return list;
    }
    
    /**
     * 
     * @describe  删除索引，重新建索引，刷新索引
     *
     * @author bowen_bao
     * @date 2015年9月8日
     * @param
     * @return
     */
    @RequestMapping(value = "/allDelete")
    @ResponseBody
    public String deleteAllAndCreateAll(){
    		searchIndexService.deleteAll();
        	searchUtil.refreshSearch();
        	refreshSearch();
        	pnplsService.readGoodsToRAM();
        	return "OK";
    }
    
    
    
    //测试SVN
    
}

```



### search410

####  定时同步行业词库


####  通过API扩展词典

```
IK 分词器支持使用 API 编程模型扩充您的词典和停止词典。如果您的个性化词典是存储与数据库中，这个方式应该对您适用。API 如下： 
类 org.wltea.analyzer.dic.Dictionary 
说明：  IK 分词器的词典对象。它负责中文词汇的加载，内存管理和匹配检索。
  public static Dictionary initial(Configuration cfg) 
说明：初始化字典实例。字典采用单例模式，一旦初始化，实例就固定. 
PS:注意该方法只能调用一次。 
参数 1：Configuration cfg  ，  词典路径配置 
返回值：Dictionary   IK 词典单例 
  public static Dictionary getSingleton() 
说明：获取初始化完毕的字典单例 
返回值：Dictionary   IK 词典单例 
  public void addWords(Collection<String> words) 
说明：加载用户扩展的词汇列表到 IK 的主词典中，增加分词器的可识别词语。 
参数 1：Collection<String> words  ，  扩展的词汇列表 
返回值：无 
  public void disableWords(Collection<String> words) 
说明：屏蔽词典中的词元 
参数 1：Collection<String> words，  待删除的词列表 
返回值：无 
```
---
layout: post
title: lucene 笔记
permalink: /:categories/lucene_url/
date: 2016-11-01 09:30:15 +0800
category: Java Search
tags: [lucene]
---



### Apache Lucene 4.10.4   JDK 1.7

####  meaven pom.xml  相关配置
```
<!-- org.apache.lucene 4.10.4 -->
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-core</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-analyzers-common</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-queryparser</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-highlighter</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-sandbox</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-queries</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-memory</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-codecs</artifactId>
			<version>4.10.4</version>
		</dependency>
		<dependency>
			<groupId>org.apache.lucene</groupId>
			<artifactId>lucene-analyzers-icu</artifactId>
			<version>4.10.4</version>
		</dependency>
```

####  ik 手工配置
```
		<dependency>
			<groupId>org.wltea</groupId>
			<artifactId>IKAnalyzer</artifactId>
			<version>IKAnalyzer2012FF_u1</version>
		</dependency>
```
IK包名:IKAnalyzer-IKAnalyzer2012FF_u1.jar


#### java 代码块

##### SearchConstant.java   全局配置类

```
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.Properties;
import org.apache.lucene.document.DoubleField;
import org.apache.lucene.document.FieldType;
import org.apache.lucene.document.FloatField;
import org.apache.lucene.document.IntField;
import org.apache.lucene.document.LongField;
import org.apache.lucene.index.FieldInfo.IndexOptions;
import org.apache.lucene.util.Version;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * @describe 系统常量类
 * @author bowen_bao
 * @date 2015年9月8日
 */
public class SearchConstant {
	
	 private static Logger logger = LoggerFactory.getLogger(SearchConstant.class);
		  
	 //搜索index path
	 public final static String ECNEW_INDEX_PATH="/opt/searchIndex/ecnew";        //服务器搜索索引库地址
	 
	 //搜索lucene版本
	 public final static Version SYS_LUCENE_VERSION=Version.LUCENE_4_10_4;
	 
	 //搜索高亮标签
	 public final static String HIGHLIGHT_BEGIN="<font color='#ec6a00'>"; 
	 public final static String HIGHLIGHT_END="</font>";
	
	 //定义索引的数据格式
	public static final FieldType STORE_YES_ANALYZED=new FieldType();//存储、分词
	public static final FieldType STORE_YES_ANALYZED_NO=new FieldType();//存储，不分词
	public static final FieldType STORE_YES_INDEX_NO=new FieldType();//存储，不索引
	public static final FieldType STORE_NO_ANALYZED=new FieldType();//不存储，分词
	public static final FieldType STORE_NO_ANALYZED_NO=new FieldType();//不存储，不分词
	
	public static final FieldType STORE_YES_INT=IntField.TYPE_STORED;//Int 存储
	public static final FieldType STORE_YES_LONG=LongField.TYPE_STORED;//Long 存储
	public static final FieldType STORE_YES_FLOAT=FloatField.TYPE_STORED;//Float 存储
	public static final FieldType STORE_YES_DOUBLE=DoubleField.TYPE_STORED;//Double存储
		
		
		static{
			STORE_YES_ANALYZED.setStored(true);
			STORE_YES_ANALYZED.setIndexed(true);
			STORE_YES_ANALYZED.setTokenized(true);//分词
			STORE_YES_ANALYZED.setOmitNorms(false);//是否忽略加权基准值     true:忽略    false:不忽略      加权基准值:长度标准化因子、字段权重
			/**
			    IndexOptions  修改倒排索引属性
				IndexOptions.DOCS_ONLY  documemts被索引，词频和位置被忽略
				IndexOptions.DOCS_AND_FREQS   documents、词频被索引，term位置被忽略    对field短语或有关位置的查询会抛异常
				IndexOptions.DOCS_AND_FREQS_AND_POSITIONS  全文索引的默认设置：打分、位置检索都支持
				IndexOptions.DOCS_AND_FREQS_AND_POSITIONS_AND_OFFSETS  索引字符相对位置的偏移量
			 */
			STORE_YES_ANALYZED.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);
			STORE_YES_ANALYZED.freeze(); //阻止field属性未来可能的变更
			
			
			STORE_YES_ANALYZED_NO.setStored(true);
			STORE_YES_ANALYZED_NO.setIndexed(true);
			STORE_YES_ANALYZED_NO.setTokenized(false);
			STORE_YES_ANALYZED_NO.setOmitNorms(false);
			STORE_YES_ANALYZED_NO.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);
			STORE_YES_ANALYZED_NO.freeze();
			
			
			STORE_YES_INDEX_NO.setStored(true);
			STORE_YES_INDEX_NO.setIndexed(false);
			STORE_YES_INDEX_NO.setTokenized(false);
			STORE_YES_INDEX_NO.setOmitNorms(true);
			STORE_YES_INDEX_NO.setIndexOptions(null);//只存储，不索引，无倒排索引属性
			STORE_YES_INDEX_NO.freeze();
			
			
			STORE_NO_ANALYZED.setStored(false);
			STORE_NO_ANALYZED.setIndexed(true);
			STORE_NO_ANALYZED.setTokenized(true);
			STORE_NO_ANALYZED.setOmitNorms(false);
			STORE_NO_ANALYZED.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);
			STORE_NO_ANALYZED.freeze();
			
			STORE_NO_ANALYZED_NO.setStored(false);
			STORE_NO_ANALYZED_NO.setIndexed(true);
			STORE_NO_ANALYZED_NO.setTokenized(false);
			STORE_NO_ANALYZED_NO.setOmitNorms(false);
			STORE_NO_ANALYZED_NO.setIndexOptions(IndexOptions.DOCS_AND_FREQS_AND_POSITIONS);
			STORE_NO_ANALYZED_NO.freeze();
			
		}
		
		
		//indexReader刷新器时间
		public static final long INDEXREADER_SLEEP_TIME=1*1000L;
			    
		 
		
}

```


#####  SearchUtil  核心类：  Analyzer  IndexWriter  IndexSearch  Similarity 的定义
```

import java.io.File;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import org.apache.lucene.analysis.Analyzer;
import org.apache.lucene.analysis.miscellaneous.PerFieldAnalyzerWrapper;
import org.apache.lucene.index.DirectoryReader;
import org.apache.lucene.index.IndexReader;
import org.apache.lucene.index.IndexWriter;
import org.apache.lucene.index.IndexWriterConfig;
import org.apache.lucene.index.IndexWriterConfig.OpenMode;
import org.apache.lucene.search.IndexSearcher;
import org.apache.lucene.search.similarities.Similarity;
import org.apache.lucene.store.Directory;
import org.apache.lucene.store.FSDirectory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;
import org.wltea.analyzer.lucene.IKAnalyzer;
import com.sekorm.searchengine.common.constant.SearchConstant;

@Component("searchUtil")
public class SearchUtil {
	
	private final Logger log = LoggerFactory.getLogger(this.getClass());
	
	private  IndexWriter indexWriter=null;
	private  IndexSearcher  indexSearcher=null;
	private  Analyzer analyzer=null;               //默认分词器
	private  Analyzer commaAnalyzer=null;          //自定义分词器
	private  String indexPath=SearchConstant.ECNEW_INDEX_PATH;  //索引path
	private  Similarity ecnewSimilarity=null;     //自定义相似器
	
	
	SearchUtil(){
		init();
	}
	
	/**
	 * 
	 * @describe 初始化相关数据
	 *
	 * @author bowen_bao
	 * @date 2015年7月20日
	 * @param
	 * @return
	 */
	public void init(){
		new Thread(){
			public void run(){
				initData();
			}
		}.start();
	}
	
	public synchronized void initData(){
		try {
			log.info("===SearchUtil initDate start===");
			
			//索引目录
			Directory indexDir=FSDirectory.open(new File(indexPath));
			
			Analyzer  defaultAnalyzer=new IKAnalyzer();
			Analyzer  patternAnalyzer=new PatternAnalyzer(",");
			Map<String,Analyzer> fieldAnalyzers=new HashMap<String,Analyzer>();
			//需要逗号分词的
			fieldAnalyzers.put("keyword", patternAnalyzer);
			fieldAnalyzers.put("searchKeyword", patternAnalyzer);
			fieldAnalyzers.put("brandName", patternAnalyzer);
			fieldAnalyzers.put("brandKeyword", patternAnalyzer);
			fieldAnalyzers.put("goodsName", patternAnalyzer);
			fieldAnalyzers.put("elecName", patternAnalyzer);
			fieldAnalyzers.put("sname",patternAnalyzer);
			fieldAnalyzers.put("skeyword", patternAnalyzer);
			fieldAnalyzers.put("plName",patternAnalyzer);
			fieldAnalyzers.put("plKeyword", patternAnalyzer);
			fieldAnalyzers.put("pnName",patternAnalyzer);
			fieldAnalyzers.put("pnKeyword", patternAnalyzer);
			fieldAnalyzers.put("pnResemblecode",patternAnalyzer);
			fieldAnalyzers.put("pnPackages",patternAnalyzer);
			fieldAnalyzers.put("pnPacking",patternAnalyzer);
			fieldAnalyzers.put("searchKeywordindex",patternAnalyzer);
			
			
			//PerFieldAnalyzerWrapper 可以使得不同的field使用不同的analyzer进行搜索,相当于Analyzer的组
			PerFieldAnalyzerWrapper ecanalyzer=new PerFieldAnalyzerWrapper(defaultAnalyzer,fieldAnalyzers);
			
			//创建indexWriter  索引写者
			IndexWriterConfig iwc=new IndexWriterConfig(SearchConstant.SYS_LUCENE_VERSION,ecanalyzer);
			iwc.setOpenMode(OpenMode.CREATE_OR_APPEND);
			//设置自己的相似器
			iwc.setSimilarity(getEcnewSimilarity());			
			indexWriter=new IndexWriter(indexDir, iwc);
			
			//创建indexSearcher  索引读者
			IndexReader indexReader=DirectoryReader.open(indexWriter,true);			
			indexSearcher=new IndexSearcher(indexReader);

			//设置自己的相似器
			indexSearcher.setSimilarity(getEcnewSimilarity());
			
			analyzer=new IKAnalyzer();
			
			log.info("===SearchUtil initDate end===");
			
		} catch (Exception e) {
			log.info("===SearchUtil initDate error===",e);
		}
	}
	
	public IndexWriter getIndexWriter(){
		if(indexWriter!=null){
			return indexWriter;
		}else{
			initData();
			return indexWriter;
		}
	}
	
	
	public IndexSearcher getIndexSearcher(){
		if(indexSearcher!=null){
			return indexSearcher;
		}else{
			initData();
			return indexSearcher;
		}
	}
	
	public Analyzer getAnalyzer(){
		if(analyzer!=null){
			return analyzer;
		}else{
			return new IKAnalyzer();
		}
	}
	
	/**
	 * 自定义{ 英文,}分词器
	 * @return   Analyzer
	 */
	public Analyzer getcommaAnalyzer(){
		if(commaAnalyzer!=null){
			return commaAnalyzer;
		}else{
			return new PatternAnalyzer(",");
		}
	} 
	
	/**
	 * Lucene 对时间段的查询比较弱，把时间转成long ,对long 进行氛围search
	 * @describe  时间  ：  String yyyy-MM-dd hh:mm:ss 转Long	
	 * @author bowen_bao
	 * @date 2015年7月20日
	 * @param
	 * @return
	 */
	public Long DateStringToLong(String date){
		try {
			Date d=new SimpleDateFormat("yyyy-MM-dd hh:mm:ss").parse(date);
			return d.getTime();
		} catch (ParseException e) {
			log.error("SearchUtil  DateStringToLong error" + e.getMessage());
			e.printStackTrace();
		}
		return 0l;
	}
	
	
	//在indexWriter 更新索引后，索引commit，更新indexSearch
	public synchronized  void refreshSearch(){
		try {
			IndexReader oldReader=indexSearcher.getIndexReader();
			indexWriter.commit();
			IndexReader newReader=DirectoryReader.openIfChanged((DirectoryReader) oldReader,indexWriter,true);
			if(null!=newReader && newReader!=oldReader){
				indexSearcher=new IndexSearcher(newReader);
				indexSearcher.setSimilarity(getEcnewSimilarity());//更新indexSearch时，需要设置相似器
				Thread.sleep(SearchConstant.INDEXREADER_SLEEP_TIME);
				oldReader.close();
			}
		} catch (Exception e) {
			log.error("SearchUtil refreshSearch error ",e);
		}
	}
	
	public Similarity   getEcnewSimilarity(){
		if(ecnewSimilarity==null){
			ecnewSimilarity=new EcNewSimilarity();
			return ecnewSimilarity;
		}else{
			return ecnewSimilarity;
		}
	}
	
	
	//***************************************************非搜索Util
	
	/**
	 * list 集合转String  ,以 逗号连接
	 */
	public String  ListToString(List<String> list){
		String str="";
		for(String s:list){
			str+=s+",";
		}
		if(!"".equals(str)  &&  str.length()>0){
			str=str.substring(0, str.length()-1);
		}
		return str;
	}
	
	/**
	 * String  ,以 逗号连接 转 list 集合
	 */
	public List<String>  StringToList(String keyword){
		List<String> list=new ArrayList<String>();
		String[] str=keyword.split(",");
		for(int i=0;i<str.length;i++){
			list.add(str[i]);
		}
		return list;
	}
	
}

```



